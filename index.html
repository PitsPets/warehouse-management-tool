<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Warehouse Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Firebase Configuration & Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9Tf7tOlZhYNe6ubDZ7JFJhsMswiimxPw",
            authDomain: "dlv-warehouse-tracker.firebaseapp.com",
            projectId: "dlv-warehouse-tracker",
            storageBucket: "dlv-warehouse-tracker.appspot.com",
            messagingSenderId: "267729758583",
            appId: "1:267729758583:web:f5f7ca26afc99c17819972",
            measurementId: "G-1DH9GT5RXS"
        };
        const appId = 'dlv-warehouse-tracker';
        
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth.getAuth(app);
        const db = firebase.firestore.getFirestore(app);

        // --- Helper Components & Functions ---
        const formatCurrency = (value) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(value || 0);

        const Modal = ({ children, onClose, size = 'md' }) => {
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', '3xl': 'max-w-3xl', '5xl': 'max-w-5xl', '7xl': 'max-w-7xl' };
            return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 transition-opacity duration-300"><div className={`bg-white rounded-2xl shadow-2xl w-full ${sizeClasses[size]} p-6 relative transform transition-all duration-300 scale-95 opacity-0 animate-scale-in`}><button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors z-10" aria-label="Close modal"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>{children}</div></div>);
        };

        const Spinner = ({ text = "Loading..." }) => <div className="bg-gray-100 min-h-screen flex flex-col justify-center items-center p-4"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div><p className="mt-4 text-gray-500">{text}</p></div>;

        const ConfirmationModal = ({ isOpen, onClose, onConfirm, message }) => !isOpen ? null : <Modal onClose={onClose}><div className="text-center"><h3 className="text-lg font-medium text-gray-900 mb-4">{message}</h3><div className="flex justify-center gap-4"><button onClick={onClose} className="px-6 py-2 text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200">Cancel</button><button onClick={onConfirm} className="px-6 py-2 text-white bg-red-600 rounded-full hover:bg-red-700">Confirm</button></div></div></Modal>;

        const logAction = async (userName, action, details) => {
            const { collection, addDoc, serverTimestamp } = window.firebase.firestore;
            try { await addDoc(collection(db, `artifacts/${appId}/public/data/logs`), { timestamp: serverTimestamp(), action, details, user: userName }); } 
            catch (error) { console.error("Failed to log action:", error); }
        };

        const ChartComponent = ({ type, data, options }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (!chartRef.current || !window.Chart) return;
                if (chartInstance.current) chartInstance.current.destroy();
                chartInstance.current = new window.Chart(chartRef.current, { type, data, options });
                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, [data, type, options]);
            return <canvas ref={chartRef}></canvas>;
        };

        const AnalyticsDashboard = ({ inventory, receipts }) => {
            const topItemsData = {
                labels: inventory.sort((a,b) => (b.qty * b.price) - (a.qty * a.price)).slice(0,10).map(i => i.name),
                datasets: [{ label: 'Total Value (PHP)', data: inventory.sort((a,b) => (b.qty * b.price) - (a.qty * a.price)).slice(0,10).map(i => i.qty * i.price), backgroundColor: 'rgba(79, 70, 229, 0.8)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }]
            };
            const categoryData = inventory.reduce((acc, item) => { const category = item.category || 'standard'; acc[category] = (acc[category] || 0) + 1; return acc; }, {});
            const categoryChartData = {
                labels: Object.keys(categoryData).map(k => k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
                datasets: [{ label: 'Inventory by Category', data: Object.values(categoryData), backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6'] }]
            };
            const totalCOGS = receipts.reduce((sum, r) => sum + r.totalValue, 0);
            const avgInventoryValue = inventory.reduce((sum, i) => sum + (i.price * i.qty), 0) / (inventory.length || 1);
            const turnoverRatio = avgInventoryValue > 0 ? (totalCOGS / avgInventoryValue).toFixed(2) : 0;
            const now = Date.now();
            const thirtyDays = 30 * 24 * 60 * 60 * 1000;
            const sixtyDays = 60 * 24 * 60 * 60 * 1000;
            const ninetyDays = 90 * 24 * 60 * 60 * 1000;
            const stockAging = inventory.reduce((acc, item) => {
                const age = now - (item.createdAt?.seconds * 1000 || now);
                if (age < thirtyDays) acc['0-30']++;
                else if (age < sixtyDays) acc['31-60']++;
                else if (age < ninetyDays) acc['61-90']++;
                else acc['90+']++;
                return acc;
            }, { '0-30': 0, '31-60': 0, '61-90': 0, '90+': 0 });
            return (<div className="space-y-6"><h2 className="text-2xl font-bold text-gray-800">Analytics & Reports</h2><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><div className="lg:col-span-2 p-6 bg-white rounded-2xl shadow-lg"><h3 className="text-lg font-bold mb-4">Top 10 Most Valuable Items</h3><ChartComponent type="bar" data={topItemsData} options={{ scales: { y: { beginAtZero: true } } }} /></div><div className="p-6 bg-white rounded-2xl shadow-lg"><h3 className="text-lg font-bold mb-4">Inventory by Category</h3><ChartComponent type="pie" data={categoryChartData} /></div><div className="p-6 bg-white rounded-2xl shadow-lg"><h3 className="text-lg font-bold mb-4">Inventory Turnover Ratio</h3><p className="text-4xl font-bold text-indigo-600">{turnoverRatio}</p><p className="text-sm text-gray-500 mt-2">A higher ratio generally indicates better performance.</p></div><div className="lg:col-span-2 p-6 bg-white rounded-2xl shadow-lg"><h3 className="text-lg font-bold mb-4">Stock Aging (Days)</h3><div className="grid grid-cols-4 gap-4 text-center"><div><p className="text-2xl font-bold">{stockAging['0-30']}</p><p className="text-sm text-gray-500">0-30</p></div><div><p className="text-2xl font-bold">{stockAging['31-60']}</p><p className="text-sm text-gray-500">31-60</p></div><div><p className="text-2xl font-bold">{stockAging['61-90']}</p><p className="text-sm text-gray-500">61-90</p></div><div><p className="text-2xl font-bold">{stockAging['90+']}</p><p className="text-sm text-gray-500">90+</p></div></div></div></div></div>);
        };
        
        // ... all other component functions ...

        function App() {
            // All state and handler functions
            const [user, setUser] = useState(null);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [inventory, setInventory] = useState([]);
            const [sites, setSites] = useState([]);
            const [receipts, setReceipts] = useState([]);
            const [settings, setSettings] = useState({ adminPass: 'superadmin' });
            const [isLoading, setIsLoading] = useState(true);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [modal, setModal] = useState(null);
            const [currentItem, setCurrentItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [itemToDelete, setItemToDelete] = useState(null);
            
            useEffect(() => {
                const { onAuthStateChanged, signInAnonymously } = window.firebase.auth;
                onAuthStateChanged(auth, async authUser => {
                    if (authUser) { setUser(authUser); } 
                    else { try { await signInAnonymously(auth); } catch (e) { console.error("Anonymous sign-in failed", e); } }
                    setIsAuthReady(true);
                });
            }, []);

            useEffect(() => {
                if (!isAuthReady) return;
                const { collection, query, orderBy, onSnapshot, doc } = window.firebase.firestore;
                const basePath = `artifacts/${appId}/public/data`;
                setIsLoading(true);
                const unsubInv = onSnapshot(query(collection(db, `${basePath}/inventory`), orderBy('name')), snap => setInventory(snap.docs.map(d => ({ id: d.id, ...d.data(), createdAt: d.data().createdAt }))));
                const unsubSites = onSnapshot(query(collection(db, `${basePath}/sites`), orderBy('name')), snap => setSites(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubSettings = onSnapshot(doc(db, `${basePath}/settings`, 'general'), (d) => { if (d.exists()) { setSettings(s => ({...s, ...d.data()})); } });
                const unsubReceipts = onSnapshot(query(collection(db, `${basePath}/deliveryReceipts`), orderBy('createdAt', 'desc')), snap => setReceipts(snap.docs.map(d => ({id:d.id, ...d.data()}))));
                setIsLoading(false);
                return () => { unsubInv(); unsubSites(); unsubSettings(); unsubReceipts(); };
            }, [isAuthReady]);

            const handleSaveItem = async (item) => {
                 const { doc, updateDoc, addDoc, collection, serverTimestamp } = window.firebase.firestore;
                const path = `artifacts/${appId}/public/data/inventory`;
                const itemToSave = { ...item, createdAt: currentItem?.id ? item.createdAt : serverTimestamp() };
                try {
                    if (currentItem?.id) { await updateDoc(doc(db, path, currentItem.id), itemToSave); await logAction(isAdminMode ? 'Admin' : 'User', 'Item Updated', `${item.name} (${item.sku})`); } 
                    else { await addDoc(collection(db, path), itemToSave); await logAction(isAdminMode ? 'Admin' : 'User', 'Item Added', `${item.name} (${item.sku})`); }
                    setModal(null); setCurrentItem(null);
                } catch (e) { console.error("Save error:", e); }
            };

            const confirmDeleteItem = (id) => setItemToDelete(id);
            const handleDeleteItem = async () => {
                if (!itemToDelete) return;
                 const { doc, deleteDoc } = window.firebase.firestore;
                const item = inventory.find(i => i.id === itemToDelete);
                try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/inventory`, itemToDelete)); await logAction(isAdminMode ? 'Admin' : 'User', 'Item Deleted', `${item.name} (${item.sku})`); } 
                catch (e) { console.error("Delete error:", e); } finally { setItemToDelete(null); }
            };
            
            const handleAdjustStock = async (item, adjustment) => {
                 const { doc, updateDoc } = window.firebase.firestore;
                const newQty = Number(item.qty) + adjustment;
                if (newQty < 0) { alert("Stock cannot go below zero."); return; }
                await updateDoc(doc(db, `artifacts/${appId}/public/data/inventory`, item.id), { qty: newQty });
                await logAction(isAdminMode ? 'Admin' : 'User', adjustment > 0 ? "Stock In" : "Stock Out", `${Math.abs(adjustment)}x ${item.name}. New Qty: ${newQty}.`);
                setModal(null);
            };

            const handleAdminLogin = (password) => {
                if(password === settings.adminPass) { setIsAdminMode(true); setModal(null); } 
                else { alert('Incorrect admin password.'); }
            };

            const openModal = (type, item = null) => { setCurrentItem(item); setModal(type); };
            
            const filteredInventory = inventory.filter(item => (item.name?.toLowerCase() || '').includes(searchTerm.toLowerCase()) || (item.brand?.toLowerCase() || '').includes(searchTerm.toLowerCase()) || (item.sku?.toLowerCase() || '').includes(searchTerm.toLowerCase()));
            
            if (!isAuthReady || !user) return <Spinner />;

            return (
                <div className="bg-gray-100 min-h-screen font-sans">
                     <style>{`@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap'); body { font-family: 'Poppins', sans-serif; } @keyframes scale-in{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}.animate-scale-in{animation:scale-in .2s ease-out forwards}@media print{body *{visibility:hidden}.printable-area,.printable-area *{visibility:visible}.printable-area{position:absolute;left:0;top:0;width:100%}.no-print{display:none}}`}</style>
                    <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                        <header className="flex flex-wrap justify-between items-center gap-4 mb-8">
                            <div><h1 className="text-4xl font-bold text-gray-800">Warehouse Management</h1><p className="text-gray-500 mt-1">Logged in as: <span className={isAdminMode ? "font-bold text-indigo-600" : ""}>{isAdminMode ? "Administrator" : "User"}</span></p></div>
                            <div className="flex gap-2">
                                <button onClick={() => openModal('admin_login')} className="bg-white text-gray-700 font-semibold p-2 rounded-full hover:bg-gray-100 shadow-sm border" title="Admin Access">🛡️</button>
                                {isAdminMode && <button onClick={() => openModal('sites')} className="bg-white text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">Manage Sites</button>}
                                {isAdminMode && <button onClick={() => openModal('settings')} className="bg-white text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">⚙️ Settings</button>}
                                <button onClick={() => openModal('reports')} className="bg-white text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">📊 Reports</button>
                                <button onClick={() => openModal('dr_history')} className="bg-white text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">View Receipts</button>
                                <button onClick={() => openModal('receipt')} className="bg-teal-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-teal-600 shadow-md">🧾 Create Receipt</button>
                                {isAdminMode && <button onClick={() => openModal('item')} className="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-indigo-700 shadow-md">➕ Add Item</button>}
                            </div>
                        </header>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="lg:col-span-3"><StatsWidget inventory={filteredInventory} /></div>
                            <LogsWidget isLoading={isLoading} />
                            <AllInventoryWidget inventory={filteredInventory} onEdit={(item) => openModal('item', item)} onDelete={confirmDeleteItem} onAdjustStock={(item) => openModal('stock', item)} isLoading={isLoading} searchTerm={searchTerm} setSearchTerm={setSearchTerm} isAdminMode={isAdminMode} settings={settings} />
                        </div>
                    </div>
                    {/* All modals go here... */}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
