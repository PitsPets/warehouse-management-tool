<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Warehouse Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, writeBatch, increment, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules to the global window object for Babel to access
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, writeBatch, increment, runTransaction
        };
    </script>

</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <!-- This div is used specifically for printing content -->
    <div id="print-area" class="hidden print:block"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        // Destructure Firebase functions from the global window object
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, writeBatch, increment, runTransaction } = window.firebase;

        // --- Firebase Globals (will be initialized in the App component) ---
        let db, auth;

        // --- Utility Functions ---
        const formatCurrency = (value) => new Intl.NumberFormat('en-PH', { style: 'currency', currency: 'PHP' }).format(value || 0);

        const isBrowserEnvironment = typeof window !== 'undefined' && typeof window.localStorage !== 'undefined';

        const loadStoredJSON = (key, fallback = null) => {
            if (!isBrowserEnvironment) return fallback;
            try {
                const rawValue = window.localStorage.getItem(key);
                return rawValue ? JSON.parse(rawValue) : fallback;
            } catch (error) {
                console.warn(`Failed to parse stored value for "${key}":`, error);
                return fallback;
            }
        };

        const persistStoredJSON = (key, value) => {
            if (!isBrowserEnvironment) return;
            try {
                if (value === null || value === undefined) {
                    window.localStorage.removeItem(key);
                } else {
                    window.localStorage.setItem(key, JSON.stringify(value));
                }
            } catch (error) {
                console.warn(`Failed to persist value for "${key}":`, error);
            }
        };

        const escapeCSVValue = (value) => {
            if (value === null || value === undefined) return '';
            const stringValue = String(value).replace(/\r?\n|\r/g, ' ');
            if (/[",]/.test(stringValue)) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        };

        const exportInventoryToCSV = (items = []) => {
            if (!Array.isArray(items) || items.length === 0) return;
            const headers = ['SKU', 'Name', 'Brand', 'Preferred Unit', 'Quantity', 'Unit Price', 'Reorder Level'];
            const rows = items.map(item => [
                item.sku || '',
                item.name || '',
                item.brand || '',
                normalizeUnitValue(item.unit || item.issuingUnit || getPrimaryIssuingUnit(item)),
                item.qty === undefined || item.qty === null ? '' : item.qty,
                item.price === undefined || item.price === null ? '' : item.price,
                item.reorderLevel === undefined || item.reorderLevel === null ? '' : item.reorderLevel
            ]);

            const csvContent = [headers, ...rows].map(row => row.map(escapeCSVValue).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `inventory-export-${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const formatDateForSearch = (timestamp) => {
            if (!timestamp) return '';
            try {
                const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
                if (Number.isNaN(date.getTime())) return '';
                const iso = date.toISOString().slice(0, 10);
                const locale = date.toLocaleDateString();
                const longLocale = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                return `${iso} ${locale} ${longLocale}`.toLowerCase();
            } catch (error) {
                return '';
            }
        };

        const normalizeTimestamp = (timestamp) => {
            if (!timestamp) return null;
            try {
                if (typeof timestamp.toDate === 'function') {
                    const date = timestamp.toDate();
                    if (!Number.isNaN(date.getTime())) {
                        return date;
                    }
                }
                const date = new Date(timestamp);
                return Number.isNaN(date.getTime()) ? null : date;
            } catch (error) {
                return null;
            }
        };

        const STORAGE_KEYS = {
            manualReceiptDraft: 'wm_manual_receipt_draft',
            inventoryReceiptDraft: 'wm_inventory_receipt_draft'
        };

        const UNIT_DISPLAY_OVERRIDES = {
            'pc': 'PC/s',
            'pcs': 'PC/s',
            'pc/s': 'PC/s',
            'roll': 'Roll/s',
            'rolls': 'Roll/s',
            'roll/s': 'Roll/s',
            'meter': 'Meter/s',
            'meters': 'Meter/s',
            'meter/s': 'Meter/s',
            'set': 'Set/s',
            'sets': 'Set/s',
            'set/s': 'Set/s',
            'assy': 'Assy',
            'box': 'Box',
            'length': 'Length'
        };

        const DEFAULT_ISSUING_UNITS = ['PC/s', 'Roll/s', 'Meter/s', 'Box', 'Length', 'Assy', 'Set/s'];

        const normalizeUnitValue = (value) => {
            if (typeof value !== 'string') return '';
            const trimmed = value.trim();
            if (!trimmed) return '';
            const key = trimmed.toLowerCase();
            if (UNIT_DISPLAY_OVERRIDES[key]) {
                return UNIT_DISPLAY_OVERRIDES[key];
            }
            if (trimmed.includes('/')) {
                return trimmed
                    .split('/')
                    .map((segment, index) => index === 0
                        ? segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase()
                        : segment.toLowerCase())
                    .join('/');
            }
            if (trimmed.length <= 4) {
                return trimmed.toUpperCase();
            }
            return trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
        };

        const uniqueUnits = (list) => {
            const seen = new Set();
            const ordered = [];
            list.forEach(unit => {
                const normalized = normalizeUnitValue(unit);
                if (!normalized) return;
                const key = normalized.toLowerCase();
                if (seen.has(key)) return;
                seen.add(key);
                ordered.push(normalized);
            });
            return ordered;
        };

        const ensurePreferredUnitList = (units = []) => {
            const source = Array.isArray(units) ? units : [];
            const normalizedSource = source.map(normalizeUnitValue);
            return uniqueUnits([...DEFAULT_ISSUING_UNITS, ...normalizedSource]);
        };

        const GLOBAL_UNIT_OPTIONS = ensurePreferredUnitList();

        const getPreferredUnit = (units) => {
            const normalized = ensurePreferredUnitList(Array.isArray(units) ? units : []);
            return normalized.find(unit => unit.toLowerCase() === 'pc/s') || normalized[0] || 'PC/s';
        };

        const resolveUnitOptions = (item = {}) => {
            const candidateLists = [item.issuingUnits, item.units, item.unitOptions, item.allowedUnits];
            for (const list of candidateLists) {
                if (Array.isArray(list) && list.length > 0) {
                    const cleaned = ensurePreferredUnitList(list);
                    if (cleaned.length > 0) {
                        return cleaned;
                    }
                }
            }
            const fallbackCandidates = [item.issuingUnit, item.unit, item.defaultUnit].filter(Boolean);
            const fallbackUnits = ensurePreferredUnitList(fallbackCandidates);
            if (fallbackUnits.length > 0) {
                return fallbackUnits;
            }
            return ensurePreferredUnitList();
        };

        const getPrimaryIssuingUnit = (item = {}) => {
            if (typeof item.unit === 'string' && item.unit.trim()) {
                return normalizeUnitValue(item.unit);
            }
            if (typeof item.issuingUnit === 'string' && item.issuingUnit.trim()) {
                return normalizeUnitValue(item.issuingUnit);
            }
            const options = resolveUnitOptions(item);
            return options.length > 0 ? options[0] : 'PC/s';
        };

        const isBrowserEnvironment = typeof window !== 'undefined' && typeof window.localStorage !== 'undefined';

        const loadStoredJSON = (key, fallback = null) => {
            if (!isBrowserEnvironment) return fallback;
            try {
                const rawValue = window.localStorage.getItem(key);
                return rawValue ? JSON.parse(rawValue) : fallback;
            } catch (error) {
                console.warn(`Failed to parse stored value for "${key}":`, error);
                return fallback;
            }
        };

        const persistStoredJSON = (key, value) => {
            if (!isBrowserEnvironment) return;
            try {
                if (value === null || value === undefined) {
                    window.localStorage.removeItem(key);
                } else {
                    window.localStorage.setItem(key, JSON.stringify(value));
                }
            } catch (error) {
                console.warn(`Failed to persist value for "${key}":`, error);
            }
        };

        const escapeCSVValue = (value) => {
            if (value === null || value === undefined) return '';
            const stringValue = String(value).replace(/\r?\n|\r/g, ' ');
            if (/[",]/.test(stringValue)) {
                return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
        };

        const exportInventoryToCSV = (items = []) => {
            if (!Array.isArray(items) || items.length === 0) return;
            const headers = ['SKU', 'Name', 'Brand', 'Preferred Unit', 'Quantity', 'Unit Price', 'Reorder Level'];
            const rows = items.map(item => [
                item.sku || '',
                item.name || '',
                item.brand || '',
                normalizeUnitValue(item.unit || item.issuingUnit || getPrimaryIssuingUnit(item)),
                item.qty === undefined || item.qty === null ? '' : item.qty,
                item.price === undefined || item.price === null ? '' : item.price,
                item.reorderLevel === undefined || item.reorderLevel === null ? '' : item.reorderLevel
            ]);

            const csvContent = [headers, ...rows].map(row => row.map(escapeCSVValue).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `inventory-export-${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const formatDateForSearch = (timestamp) => {
            if (!timestamp) return '';
            try {
                const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
                if (Number.isNaN(date.getTime())) return '';
                const iso = date.toISOString().slice(0, 10);
                const locale = date.toLocaleDateString();
                const longLocale = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                return `${iso} ${locale} ${longLocale}`.toLowerCase();
            } catch (error) {
                return '';
            }
        };

        const normalizeTimestamp = (timestamp) => {
            if (!timestamp) return null;
            try {
                if (typeof timestamp.toDate === 'function') {
                    const date = timestamp.toDate();
                    if (!Number.isNaN(date.getTime())) {
                        return date;
                    }
                }
                const date = new Date(timestamp);
                return Number.isNaN(date.getTime()) ? null : date;
            } catch (error) {
                return null;
            }
        };

        const STORAGE_KEYS = {
            manualReceiptDraft: 'wm_manual_receipt_draft',
            inventoryReceiptDraft: 'wm_inventory_receipt_draft'
        };

        const UNIT_DISPLAY_OVERRIDES = {
            'pc': 'PC/s',
            'pcs': 'PC/s',
            'pc/s': 'PC/s',
            'roll': 'Roll/s',
            'rolls': 'Roll/s',
            'roll/s': 'Roll/s',
            'meter': 'Meter/s',
            'meters': 'Meter/s',
            'meter/s': 'Meter/s',
            'set': 'Set/s',
            'sets': 'Set/s',
            'set/s': 'Set/s',
            'assy': 'Assy',
            'box': 'Box',
            'length': 'Length'
        };

        const DEFAULT_ISSUING_UNITS = ['PC/s', 'Roll/s', 'Meter/s', 'Box', 'Length', 'Assy', 'Set/s'];

        const normalizeUnitValue = (value) => {
            if (typeof value !== 'string') return '';
            const trimmed = value.trim();
            if (!trimmed) return '';
            const key = trimmed.toLowerCase();
            if (UNIT_DISPLAY_OVERRIDES[key]) {
                return UNIT_DISPLAY_OVERRIDES[key];
            }
            if (trimmed.includes('/')) {
                return trimmed
                    .split('/')
                    .map((segment, index) => index === 0
                        ? segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase()
                        : segment.toLowerCase())
                    .join('/');
            }
            if (trimmed.length <= 4) {
                return trimmed.toUpperCase();
            }
            return trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
        };

        const uniqueUnits = (list) => {
            const seen = new Set();
            const ordered = [];
            list.forEach(unit => {
                const normalized = normalizeUnitValue(unit);
                if (!normalized) return;
                const key = normalized.toLowerCase();
                if (seen.has(key)) return;
                seen.add(key);
                ordered.push(normalized);
            });
            return ordered;
        };

        const ensurePreferredUnitList = (units = []) => {
            const source = Array.isArray(units) ? units : [];
            const normalizedSource = source.map(normalizeUnitValue);
            return uniqueUnits([...DEFAULT_ISSUING_UNITS, ...normalizedSource]);
        };

        const GLOBAL_UNIT_OPTIONS = ensurePreferredUnitList();

        const getPreferredUnit = (units) => {
            const normalized = ensurePreferredUnitList(Array.isArray(units) ? units : []);
            return normalized.find(unit => unit.toLowerCase() === 'pc/s') || normalized[0] || 'PC/s';
        };

        const resolveUnitOptions = (item = {}) => {
            const candidateLists = [item.issuingUnits, item.units, item.unitOptions, item.allowedUnits];
            for (const list of candidateLists) {
                if (Array.isArray(list) && list.length > 0) {
                    const cleaned = ensurePreferredUnitList(list);
                    if (cleaned.length > 0) {
                        return cleaned;
                    }
                }
            }
            const fallbackCandidates = [item.issuingUnit, item.unit, item.defaultUnit].filter(Boolean);
            const fallbackUnits = ensurePreferredUnitList(fallbackCandidates);
            if (fallbackUnits.length > 0) {
                return fallbackUnits;
            }
            return ensurePreferredUnitList();
        };

        const getPrimaryIssuingUnit = (item = {}) => {
            if (typeof item.unit === 'string' && item.unit.trim()) {
                return normalizeUnitValue(item.unit);
            }
            if (typeof item.issuingUnit === 'string' && item.issuingUnit.trim()) {
                return normalizeUnitValue(item.issuingUnit);
            }
            const options = resolveUnitOptions(item);
            return options.length > 0 ? options[0] : 'PC/s';
        };

        const UNIT_DISPLAY_OVERRIDES = {
            'pc': 'PC/s',
            'pcs': 'PC/s',
            'pc/s': 'PC/s',
            'roll': 'Roll/s',
            'rolls': 'Roll/s',
            'roll/s': 'Roll/s',
            'meter': 'Meter/s',
            'meters': 'Meter/s',
            'meter/s': 'Meter/s',
            'set': 'Set/s',
            'sets': 'Set/s',
            'set/s': 'Set/s',
            'assy': 'Assy',
            'box': 'Box',
            'length': 'Length'
        };

        const DEFAULT_ISSUING_UNITS = ['PC/s', 'Roll/s', 'Meter/s', 'Box', 'Length', 'Assy', 'Set/s'];

        const normalizeUnitValue = (value) => {
            if (typeof value !== 'string') return '';
            const trimmed = value.trim();
            if (!trimmed) return '';
            const key = trimmed.toLowerCase();
            if (UNIT_DISPLAY_OVERRIDES[key]) {
                return UNIT_DISPLAY_OVERRIDES[key];
            }
            if (trimmed.includes('/')) {
                return trimmed
                    .split('/')
                    .map((segment, index) => index === 0
                        ? segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase()
                        : segment.toLowerCase())
                    .join('/');
            }
            if (trimmed.length <= 4) {
                return trimmed.toUpperCase();
            }
            return trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
        };

        const uniqueUnits = (list) => {
            const seen = new Set();
            const ordered = [];
            list.forEach(unit => {
                const normalized = normalizeUnitValue(unit);
                if (!normalized) return;
                const key = normalized.toLowerCase();
                if (seen.has(key)) return;
                seen.add(key);
                ordered.push(normalized);
            });
            return ordered;
        };

        const ensurePreferredUnitList = (units = []) => {
            const source = Array.isArray(units) ? units : [];
            const normalizedSource = source.map(normalizeUnitValue);
            return uniqueUnits([...DEFAULT_ISSUING_UNITS, ...normalizedSource]);
        };

        const GLOBAL_UNIT_OPTIONS = ensurePreferredUnitList();

        const getPreferredUnit = (units) => {
            const normalized = ensurePreferredUnitList(Array.isArray(units) ? units : []);
            return normalized.find(unit => unit.toLowerCase() === 'pc/s') || normalized[0] || 'PC/s';
        };

        const resolveUnitOptions = (item = {}) => {
            const candidateLists = [item.issuingUnits, item.units, item.unitOptions, item.allowedUnits];
            for (const list of candidateLists) {
                if (Array.isArray(list) && list.length > 0) {
                    const cleaned = ensurePreferredUnitList(list);
                    if (cleaned.length > 0) {
                        return cleaned;
                    }
                }
            }
            const fallbackCandidates = [item.issuingUnit, item.unit, item.defaultUnit].filter(Boolean);
            const fallbackUnits = ensurePreferredUnitList(fallbackCandidates);
            if (fallbackUnits.length > 0) {
                return fallbackUnits;
            }
            return ensurePreferredUnitList();
        };

        const getPrimaryIssuingUnit = (item = {}) => {
            if (typeof item.unit === 'string' && item.unit.trim()) {
                return normalizeUnitValue(item.unit);
            }
            if (typeof item.issuingUnit === 'string' && item.issuingUnit.trim()) {
                return normalizeUnitValue(item.issuingUnit);
            }
            const options = resolveUnitOptions(item);
            return options.length > 0 ? options[0] : 'PC/s';
        };

        // --- UI Components ---

        // A simple spinner component for loading states
        const Spinner = ({ text = "Loading..." }) => (
            <div className="fixed inset-0 bg-gray-100 bg-opacity-75 flex flex-col justify-center items-center p-4 z-[999]">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p className="mt-4 text-gray-500">{text}</p>
            </div>
        );

        // A generic modal component
        const Modal = ({ children, onClose, size = 'md', zIndexClass = 'z-50' }) => {
            const sizeClasses = { sm: 'max-w-sm', md: 'max-w-md', lg: 'max-w-lg', xl: 'max-w-xl', '3xl': 'max-w-3xl', '5xl': 'max-w-5xl', '7xl': 'max-w-7xl' };
            const overlayClasses = [
                'fixed inset-0 bg-black bg-opacity-60 flex justify-center items-start pt-12 sm:items-center p-4',
                'transition-opacity duration-300 animate-scale-in overflow-y-auto print:hidden',
                zIndexClass
            ].join(' ');
            const containerClasses = [
                'bg-white rounded-2xl shadow-2xl w-full',
                sizeClasses[size],
                'p-6 relative transform transition-all duration-300 mb-8'
            ].join(' ');
            return (
                <div
                    className={overlayClasses}
                    role="presentation"
                >
                    <div
                        className={containerClasses}
                        role="dialog"
                        aria-modal="true"
                    >
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors z-10 no-print" aria-label="Close modal">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        {children}
                    </div>
                </div>
            );
        };
        
        // A modal for showing notifications (success, error, info)
        const NotificationModal = ({ message, type, onClose }) => {
             const colors = {
                 success: 'bg-green-100 border-green-500 text-green-700',
                 error: 'bg-red-100 border-red-500 text-red-700',
                 info: 'bg-blue-100 border-blue-500 text-blue-700',
             };
             const btnColors = {
                 success: 'bg-green-600 hover:bg-green-700',
                 error: 'bg-red-600 hover:bg-red-700',
                 info: 'bg-blue-600 hover:bg-blue-700',
             }
             return (
                 <Modal onClose={onClose} size="sm" zIndexClass="z-[200]">
                     <div className="text-center">
                         <div className={`p-4 border-l-4 ${colors[type] || colors.info} rounded-lg`}>
                             <p className="font-medium">{message}</p>
                         </div>
                         <button onClick={onClose} className={`mt-4 w-full px-6 py-2 text-white ${btnColors[type] || btnColors.info} rounded-full`}>OK</button>
                     </div>
                 </Modal>
             );
        };

        // A modal for confirming actions (e.g., deletion)
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, message, confirmText = 'Confirm', cancelText = 'Cancel', confirmClass = 'bg-red-600 hover:bg-red-700' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-[100] flex justify-center items-start pt-12 sm:items-center p-4 transition-opacity duration-300 animate-scale-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative transform transition-all duration-300">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors z-10 no-print" aria-label="Close modal">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <div className="text-center">
                            <h3 className="text-lg font-medium text-gray-900 mb-4">{message}</h3>
                            <div className="flex justify-center gap-4">
                                <button onClick={onClose} className="px-6 py-2 text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200">{cancelText}</button>
                                <button onClick={onConfirm} className={`px-6 py-2 text-white rounded-full ${confirmClass}`}>{confirmText}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- Widget & Form Components ---

        // Dashboard widget showing key inventory stats
        const StatsWidget = ({ inventory }) => {
            const totalItems = inventory.length;
            const totalQuantity = inventory.reduce((sum, item) => sum + Number(item.qty || 0), 0);
            const totalValue = inventory.reduce((sum, item) => sum + (Number(item.qty || 0) * Number(item.price || 0)), 0);
            const stats = [
                { name: 'Total Unique Items', value: totalItems, icon: 'üì¶' }, 
                { name: 'Total Quantity', value: totalQuantity, icon: 'üî¢' }, 
                { name: 'Total Inventory Value', value: formatCurrency(totalValue), icon: 'üí∞' }
            ];
            return (
                <div className="bg-white rounded-2xl shadow-lg p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">At a Glance</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        {stats.map(stat => (
                            <div key={stat.name} className="bg-gray-50 rounded-lg p-4 flex items-center gap-4">
                                <div className="text-3xl">{stat.icon}</div>
                                <div>
                                    <p className="text-sm text-gray-500">{stat.name}</p>
                                    <p className="text-2xl font-bold text-gray-800">{stat.value}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Dashboard widget showing items that are low in stock
        const LowStockWidget = ({ inventory, settings, onRestock, setNotification }) => {
            const lowStockItems = useMemo(() => {
                return inventory.filter(item => {
                    const reorderLevel = Number(item.reorderLevel || settings.reorderLevel);
                    return Number(item.qty) <= reorderLevel;
                });
            }, [inventory, settings]);

            if (lowStockItems.length === 0) {
                return (
                    <div className="bg-white rounded-2xl shadow-lg p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">Stock Alerts</h3>
                        <div className="text-center py-8 flex flex-col items-center justify-center h-full">
                            <div className="text-4xl mb-2">‚úÖ</div>
                            <p className="text-gray-500">All items are well-stocked.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-orange-50 border border-orange-200 rounded-2xl shadow-lg p-6">
                    <h3 className="text-lg font-bold text-orange-800 mb-4">Low Stock Alerts ({lowStockItems.length})</h3>
                    <ul className="space-y-2 h-64 overflow-y-auto pr-2">
                        {lowStockItems.map(item => (
                            <li key={item.id} className="text-sm p-2 bg-white rounded-lg flex justify-between items-center">
                                <div>
                                    <p className="font-medium text-gray-700">{item.name}</p>
                                    <p className="text-xs text-gray-500">Stock: <span className="font-bold text-red-500">{item.qty}</span> / Reorder: {Number(item.reorderLevel || settings.reorderLevel)}</p>
                                </div>
                                <button onClick={() => { onRestock(item); setNotification({type: 'info', message: `${item.name} added to restock list.`})}} className="bg-blue-500 text-white px-3 py-1 text-xs rounded-full hover:bg-blue-600">
                                    Restock
                                </button>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        };

        // Main table displaying all inventory items
        const AllInventoryWidget = ({ inventory, onEdit, onDelete, onAdjustStock, isLoading, searchTerm, setSearchTerm, isAdminMode, settings }) => {
            const filteredInventory = useMemo(() => inventory.filter(item => 
                (item.name?.toLowerCase() || '').includes(searchTerm.toLowerCase()) || 
                (item.brand?.toLowerCase() || '').includes(searchTerm.toLowerCase()) || 
                (item.sku?.toLowerCase() || '').includes(searchTerm.toLowerCase())
            ), [inventory, searchTerm]);

            return (
                <div className="bg-white rounded-2xl shadow-lg p-6 lg:col-span-2">
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-gray-800">Global Inventory</h3>
                        <div className="flex flex-wrap gap-2 items-center justify-end w-full sm:w-auto">
                            <div className="relative w-full sm:w-64">
                                <input type="text" placeholder="Search by SKU, name..." className="w-full pl-9 pr-4 py-1.5 border border-gray-200 rounded-full text-sm" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                <svg className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            </div>
                            <button
                                type="button"
                                onClick={() => exportInventoryToCSV(filteredInventory)}
                                disabled={filteredInventory.length === 0}
                                className="px-4 py-1.5 text-sm font-semibold rounded-full border border-gray-200 text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ‚¨áÔ∏è Export CSV
                            </button>
                        </div>
                    </div>
                    {isLoading ? <Spinner text="Loading inventory..." /> : (
                        <div className="h-[60vh] border rounded-lg overflow-hidden">
                            <div className="h-full overflow-auto">
                                <table className="w-full min-w-[720px] text-left table-auto">
                                    <thead className="sticky top-0 bg-white z-10">
                                        <tr className="border-b-2 border-gray-100">
                                            <th className="p-4 text-sm font-semibold text-gray-600">SKU</th>
                                            <th className="p-4 text-sm font-semibold text-gray-600">Name</th>
                                            <th className="p-4 text-sm font-semibold text-gray-600">Price</th>
                                            <th className="p-4 text-sm font-semibold text-gray-600">Unit</th>
                                            {isAdminMode && <th className="p-4 text-sm font-semibold text-gray-600 text-right">Actions</th>}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredInventory.length > 0 ? filteredInventory.map(item => {
                                            const reorder = Number(item.reorderLevel || settings.reorderLevel);
                                            const isLowStock = Number(item.qty) <= reorder;
                                            const primaryUnit = getPrimaryIssuingUnit(item);
                                            return (
                                                <tr key={item.id} className={`border-b border-gray-100 hover:bg-gray-50 ${isLowStock ? 'bg-orange-50' : ''}`}>
                                                    <td className="p-4 font-mono text-xs text-gray-500">{item.sku}</td>
                                                    <td className="p-4">
                                                        <p className="font-medium text-gray-800">{item.name}</p>
                                                        <p className="text-sm text-gray-500">{item.brand}</p>
                                                        <p className={`text-xs font-semibold mt-1 ${isLowStock ? 'text-orange-500' : 'text-gray-500'}`}>Stock: {item.qty}</p>
                                                    </td>
                                                    <td className="p-4 text-gray-600">{formatCurrency(item.price)}</td>
                                                    <td className="p-4 text-gray-600">{primaryUnit}</td>
                                                    {isAdminMode && (
                                                        <td className="p-4 text-right">
                                                            <div className="flex justify-end gap-1">
                                                                <button onClick={() => onAdjustStock(item)} className="p-2 text-gray-400 hover:text-green-600 rounded-full hover:bg-gray-100" title="Adjust Stock">¬±</button>
                                                                <button onClick={() => onEdit(item)} className="p-2 text-gray-400 hover:text-indigo-600 rounded-full hover:bg-gray-100" title="Edit Item">‚úèÔ∏è</button>
                                                                <button onClick={() => onDelete(item.id, item.name)} className="p-2 text-gray-400 hover:text-red-600 rounded-full hover:bg-gray-100" title="Delete Item">üóëÔ∏è</button>
                                                        </div>
                                                    </td>
                                                )}
                                            </tr>
                                        )
                                    }) : (
                                        <tr><td colSpan={isAdminMode ? "5" : "4"} className="text-center p-8 text-gray-500">{searchTerm ? `No items found matching "${searchTerm}".` : `Your inventory is empty. Add an item to get started!`}</td></tr>
                                    )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Widget to display recent activity logs
        const LogsWidget = ({ isLoading, appId }) => {
            const [logs, setLogs] = useState([]);
            useEffect(() => {
                if (!db || !appId) return;
                const q = query(collection(db, `artifacts/${appId}/public/data/logs`), orderBy('timestamp', 'desc'));
                const unsub = onSnapshot(q, snapshot => setLogs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))),
                    (error) => console.error("Error fetching logs:", error));
                return () => unsub();
            }, [appId]);

            return (
                <div className="bg-white rounded-2xl shadow-lg p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">Activity Logs</h3>
                    {isLoading ? <Spinner text="Loading logs..." /> : logs.length > 0 ? (
                        <ul className="space-y-3 h-64 overflow-y-auto pr-2">
                            {logs.map(log => (
                                <li key={log.id} className="text-sm">
                                    <p className="font-medium text-gray-700">
                                        {log.action} by <span className="text-indigo-600">{log.user || 'System'}</span>: <span className="font-normal text-gray-600">{log.details}</span>
                                    </p>
                                    <p className="text-xs text-gray-400">{log.timestamp?.toDate().toLocaleString()}</p>
                                </li>
                            ))}
                        </ul>
                    ) : <p className="text-center py-8 text-gray-500">No recent activity.</p>}
                </div>
            );
        };

        const ReportsModal = ({ receipts = [], inventory = [], sites = [], onClose }) => {
            const [range, setRange] = useState('30');
            const [originFilter, setOriginFilter] = useState('all');
            const [siteFilter, setSiteFilter] = useState('all');

            const rangeOptions = [
                { value: '7', label: 'Last 7 days' },
                { value: '30', label: 'Last 30 days' },
                { value: '90', label: 'Last 90 days' },
                { value: '365', label: 'Last 12 months' },
                { value: 'all', label: 'All time' },
            ];

            const originOptions = [
                { value: 'all', label: 'All receipts' },
                { value: 'inventory', label: 'Inventory receipts' },
                { value: 'manual', label: 'Manual receipts' },
            ];

            const siteLookup = useMemo(() => {
                const map = new Map();
                sites.forEach(site => {
                    if (site?.id) {
                        map.set(site.id, site.name || site.siteName || 'Unassigned');
                    }
                });
                return map;
            }, [sites]);

            const siteOptions = useMemo(() => {
                const uniqueSites = new Set();
                receipts.forEach(receipt => {
                    const siteName = receipt.siteName || siteLookup.get(receipt.siteId) || 'Unassigned';
                    uniqueSites.add(siteName);
                });
                return Array.from(uniqueSites).sort((a, b) => a.localeCompare(b));
            }, [receipts, siteLookup]);

            const inventoryIndex = useMemo(() => {
                const map = new Map();
                inventory.forEach(item => {
                    if (item?.id) {
                        map.set(`id:${item.id}`, item);
                    }
                    if (item?.sku) {
                        map.set(`sku:${String(item.sku).toLowerCase()}`, item);
                    }
                    if (item?.name) {
                        map.set(`name:${String(item.name).toLowerCase()}`, item);
                    }
                });
                return map;
            }, [inventory]);

            const filteredReceipts = useMemo(() => {
                const now = new Date();
                const rangeDays = range === 'all' ? null : Number(range);
                const startDate = rangeDays ? new Date(now.getTime() - rangeDays * 24 * 60 * 60 * 1000) : null;

                return receipts.filter(receipt => {
                    const createdAt = normalizeTimestamp(receipt.createdAt);
                    if (startDate && (!createdAt || createdAt < startDate)) {
                        return false;
                    }

                    const status = (receipt.status || '').toLowerCase();
                    if (status === 'voided') {
                        return false;
                    }

                    const inferredOrigin = receipt.origin || ((receipt.items || []).some(item => !item?.isManual) ? 'inventory' : 'manual');
                    if (originFilter !== 'all' && inferredOrigin !== originFilter) {
                        return false;
                    }

                    const siteName = receipt.siteName || siteLookup.get(receipt.siteId) || 'Unassigned';
                    if (siteFilter !== 'all' && siteName !== siteFilter) {
                        return false;
                    }

                    return true;
                });
            }, [receipts, range, originFilter, siteFilter, siteLookup]);

            const reportData = useMemo(() => {
                let totalReceipts = 0;
                let totalItems = 0;
                let totalValue = 0;
                const usageMap = new Map();
                const siteSummaryMap = new Map();
                const timelineMap = new Map();

                filteredReceipts.forEach(receipt => {
                    const createdAt = normalizeTimestamp(receipt.createdAt);
                    const siteName = receipt.siteName || siteLookup.get(receipt.siteId) || 'Unassigned';
                    const items = Array.isArray(receipt.items) ? receipt.items : [];
                    let receiptQuantity = 0;
                    let receiptValue = 0;

                    items.forEach(item => {
                        const qtyRaw = item?.dispatchQty ?? item?.requestedQty ?? item?.quantity ?? 0;
                        const qty = Number(qtyRaw);
                        if (!Number.isFinite(qty) || qty <= 0) {
                            return;
                        }
                        const priceRaw = item?.price ?? 0;
                        const price = Number(priceRaw);
                        const safePrice = Number.isFinite(price) ? price : 0;
                        const lineValue = qty * safePrice;

                        receiptQuantity += qty;
                        receiptValue += lineValue;
                        totalItems += qty;
                        totalValue += lineValue;

                        const unit = normalizeUnitValue(item?.unit || item?.issuingUnit || 'PC/s') || 'PC/s';
                        const inventoryMatch = (item?.id && inventoryIndex.get(`id:${item.id}`))
                            || (item?.sku && inventoryIndex.get(`sku:${String(item.sku).toLowerCase()}`))
                            || (item?.name && inventoryIndex.get(`name:${String(item.name).toLowerCase()}`))
                            || null;
                        const displayName = (item?.name || inventoryMatch?.name || 'Unnamed Item').toUpperCase();
                        const sku = item?.sku || inventoryMatch?.sku || '';
                        const usageKey = `${item?.id || sku || displayName}::${unit.toLowerCase()}`;

                        if (!usageMap.has(usageKey)) {
                            usageMap.set(usageKey, {
                                key: usageKey,
                                itemId: inventoryMatch?.id || item?.id || null,
                                name: displayName,
                                sku,
                                unit,
                                totalQty: 0,
                                occurrences: 0,
                                totalValue: 0,
                                lastUsed: createdAt || null,
                            });
                        }

                        const usageEntry = usageMap.get(usageKey);
                        usageEntry.totalQty += qty;
                        usageEntry.totalValue += lineValue;
                        usageEntry.occurrences += 1;
                        if (createdAt && (!usageEntry.lastUsed || createdAt > usageEntry.lastUsed)) {
                            usageEntry.lastUsed = createdAt;
                        }
                    });

                    totalReceipts += 1;

                    const siteEntry = siteSummaryMap.get(siteName) || { siteName, count: 0, quantity: 0, value: 0 };
                    siteEntry.count += 1;
                    siteEntry.quantity += receiptQuantity;
                    siteEntry.value += receiptValue;
                    siteSummaryMap.set(siteName, siteEntry);

                    const dateKey = createdAt ? createdAt.toISOString().slice(0, 10) : 'No date';
                    const timelineEntry = timelineMap.get(dateKey) || { dateKey, date: createdAt || null, receipts: 0, quantity: 0, value: 0 };
                    timelineEntry.receipts += 1;
                    timelineEntry.quantity += receiptQuantity;
                    timelineEntry.value += receiptValue;
                    if (!timelineEntry.date && createdAt) {
                        timelineEntry.date = createdAt;
                    }
                    timelineMap.set(dateKey, timelineEntry);
                });

                const usageList = Array.from(usageMap.values()).sort((a, b) => {
                    if (b.totalQty === a.totalQty) {
                        return a.name.localeCompare(b.name);
                    }
                    return b.totalQty - a.totalQty;
                });

                const siteSummary = Array.from(siteSummaryMap.values()).sort((a, b) => {
                    if (b.value === a.value) {
                        return b.quantity - a.quantity;
                    }
                    return b.value - a.value;
                });

                const timeline = Array.from(timelineMap.values()).sort((a, b) => {
                    const aTime = a.date ? a.date.getTime() : 0;
                    const bTime = b.date ? b.date.getTime() : 0;
                    return bTime - aTime;
                });

                const averageItems = totalReceipts > 0 ? totalItems / totalReceipts : 0;
                const averageValue = totalReceipts > 0 ? totalValue / totalReceipts : 0;

                return {
                    totalReceipts,
                    totalItems,
                    totalValue,
                    averageItems,
                    averageValue,
                    usageList,
                    siteSummary,
                    timeline,
                };
            }, [filteredReceipts, inventoryIndex, siteLookup]);

            const { totalReceipts, totalItems, totalValue, averageItems, averageValue, usageList, siteSummary, timeline } = reportData;
            const topUsage = useMemo(() => usageList.slice(0, 10), [usageList]);
            const maxUsageQty = useMemo(() => topUsage.reduce((max, item) => Math.max(max, item.totalQty), 0), [topUsage]);
            const limitedTimeline = useMemo(() => timeline.slice(0, 12), [timeline]);
            const rangeLabel = rangeOptions.find(option => option.value === range)?.label || 'Selected range';

            return (
                <Modal onClose={onClose} size="7xl">
                    <div className="space-y-6 max-h-[80vh] overflow-y-auto pr-1">
                        <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">Reports & Usage Analytics</h2>
                                <p className="text-sm text-gray-500">Review delivery activity, top items, and site performance at a glance.</p>
                            </div>
                            <div className="flex flex-wrap gap-2 items-center">
                                <select value={range} onChange={(e) => setRange(e.target.value)} className="px-3 py-2 border rounded-full text-sm">
                                    {rangeOptions.map(option => (
                                        <option key={option.value} value={option.value}>{option.label}</option>
                                    ))}
                                </select>
                                <select value={originFilter} onChange={(e) => setOriginFilter(e.target.value)} className="px-3 py-2 border rounded-full text-sm">
                                    {originOptions.map(option => (
                                        <option key={option.value} value={option.value}>{option.label}</option>
                                    ))}
                                </select>
                                <select value={siteFilter} onChange={(e) => setSiteFilter(e.target.value)} className="px-3 py-2 border rounded-full text-sm">
                                    <option value="all">All sites</option>
                                    {siteOptions.map(siteName => (
                                        <option key={siteName} value={siteName}>{siteName}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div className="bg-indigo-50 border border-indigo-100 rounded-2xl p-4">
                                <p className="text-sm text-indigo-700 font-medium">Total Receipts</p>
                                <p className="text-3xl font-bold text-indigo-900">{totalReceipts.toLocaleString()}</p>
                                <p className="text-xs text-indigo-600 mt-1">{rangeLabel}</p>
                            </div>
                            <div className="bg-teal-50 border border-teal-100 rounded-2xl p-4">
                                <p className="text-sm text-teal-700 font-medium">Items Dispatched</p>
                                <p className="text-3xl font-bold text-teal-900">{totalItems.toLocaleString()}</p>
                                <p className="text-xs text-teal-600 mt-1">Total quantity across receipts</p>
                            </div>
                            <div className="bg-emerald-50 border border-emerald-100 rounded-2xl p-4">
                                <p className="text-sm text-emerald-700 font-medium">Dispatched Value</p>
                                <p className="text-3xl font-bold text-emerald-900">{formatCurrency(totalValue)}</p>
                                <p className="text-xs text-emerald-600 mt-1">Based on item prices</p>
                            </div>
                            <div className="bg-gray-50 border border-gray-100 rounded-2xl p-4">
                                <p className="text-sm text-gray-600 font-medium">Average per Receipt</p>
                                <p className="text-lg font-semibold text-gray-800">{averageItems.toLocaleString(undefined, { maximumFractionDigits: 1 })} items</p>
                                <p className="text-sm text-gray-500">{formatCurrency(averageValue)} value</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white rounded-2xl shadow-lg p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-gray-800">Most Used Items</h3>
                                    <span className="text-xs text-gray-500">Top {Math.min(topUsage.length, 10)} items</span>
                                </div>
                                {topUsage.length > 0 ? (
                                    <div className="space-y-3">
                                        {topUsage.map((item, index) => (
                                            <div key={item.key} className="border border-gray-100 rounded-xl p-3">
                                                <div className="flex justify-between items-start gap-4">
                                                    <div>
                                                        <p className="text-sm font-semibold text-gray-800">{index + 1}. {item.name}</p>
                                                        <p className="text-xs text-gray-500">{item.sku ? `SKU: ${item.sku} ‚Ä¢ ` : ''}Unit: {item.unit}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="text-lg font-bold text-gray-900">{item.totalQty.toLocaleString()} <span className="text-sm font-normal text-gray-500">{item.unit}</span></p>
                                                        <p className="text-xs text-gray-400">Across {item.occurrences} receipt{item.occurrences === 1 ? '' : 's'}</p>
                                                    </div>
                                                </div>
                                                {maxUsageQty > 0 && (
                                                    <div className="mt-2 h-2 bg-gray-100 rounded-full overflow-hidden">
                                                        <div className="h-full bg-teal-500" style={{ width: `${Math.max(5, (item.totalQty / maxUsageQty) * 100)}%` }}></div>
                                                    </div>
                                                )}
                                                <p className="mt-2 text-xs text-gray-400">Last used: {item.lastUsed ? item.lastUsed.toLocaleDateString() : 'N/A'}{item.totalValue ? ` ‚Ä¢ Value: ${formatCurrency(item.totalValue)}` : ''}</p>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-sm text-gray-500">No receipts found for the selected filters.</p>
                                )}
                            </div>

                            <div className="bg-white rounded-2xl shadow-lg p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-gray-800">Site Performance</h3>
                                    <span className="text-xs text-gray-500">Sorted by value</span>
                                </div>
                                {siteSummary.length > 0 ? (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead className="text-left text-gray-500 text-xs uppercase tracking-wide">
                                                <tr>
                                                    <th className="pb-2">Site</th>
                                                    <th className="pb-2 text-right">Receipts</th>
                                                    <th className="pb-2 text-right">Quantity</th>
                                                    <th className="pb-2 text-right">Value</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {siteSummary.map(entry => (
                                                    <tr key={entry.siteName}>
                                                        <td className="py-2 pr-2 font-medium text-gray-700">{entry.siteName}</td>
                                                        <td className="py-2 text-right text-gray-600">{entry.count.toLocaleString()}</td>
                                                        <td className="py-2 text-right text-gray-600">{entry.quantity.toLocaleString()}</td>
                                                        <td className="py-2 text-right text-gray-600">{formatCurrency(entry.value)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <p className="text-sm text-gray-500">No site activity for the selected filters.</p>
                                )}
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-lg p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-bold text-gray-800">Dispatch Activity Timeline</h3>
                                <span className="text-xs text-gray-500">Most recent {limitedTimeline.length} days</span>
                            </div>
                            {limitedTimeline.length > 0 ? (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="text-left text-gray-500 text-xs uppercase tracking-wide">
                                            <tr>
                                                <th className="pb-2">Date</th>
                                                <th className="pb-2 text-right">Receipts</th>
                                                <th className="pb-2 text-right">Quantity</th>
                                                <th className="pb-2 text-right">Value</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {limitedTimeline.map(entry => (
                                                <tr key={entry.dateKey}>
                                                    <td className="py-2 pr-2 text-gray-700">{entry.date ? entry.date.toLocaleDateString() : entry.dateKey}</td>
                                                    <td className="py-2 text-right text-gray-600">{entry.receipts.toLocaleString()}</td>
                                                    <td className="py-2 text-right text-gray-600">{entry.quantity.toLocaleString()}</td>
                                                    <td className="py-2 text-right text-gray-600">{formatCurrency(entry.value)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <p className="text-sm text-gray-500">No dispatch activity recorded for the selected range.</p>
                            )}
                        </div>
                    </div>
                </Modal>
            );
        };

        // Form for adding or editing an inventory item
        const ItemForm = ({ currentItem, onSave, onClose, setNotification, unitOptions = GLOBAL_UNIT_OPTIONS }) => {
            const sanitizedUnitOptions = useMemo(() => ensurePreferredUnitList(unitOptions), [unitOptions]);
            const preferredUnit = getPreferredUnit(sanitizedUnitOptions);

            const defaultItemState = () => ({
                name: '',
                brand: '',
                qty: '0',
                location: '',
                sku: '',
                price: '0.00',
                reorderLevel: '10',
                unit: preferredUnit,
                issuingUnit: preferredUnit,
                issuingUnits: [preferredUnit]
            });

            const [item, setItem] = useState(defaultItemState);
            const [isSaving, setIsSaving] = useState(false);
            const [isCustomUnit, setIsCustomUnit] = useState(false);

            useEffect(() => {
                if (currentItem) {
                    const existingUnit = normalizeUnitValue(currentItem.unit || currentItem.issuingUnit || preferredUnit) || preferredUnit;
                    const normalizedIssuingUnits = Array.isArray(currentItem.issuingUnits) && currentItem.issuingUnits.length > 0
                        ? ensurePreferredUnitList([existingUnit, ...currentItem.issuingUnits])
                        : ensurePreferredUnitList([existingUnit]);
                    setItem({
                        ...currentItem,
                        unit: existingUnit,
                        issuingUnit: existingUnit,
                        issuingUnits: normalizedIssuingUnits,
                        qty: String(currentItem.qty ?? 0),
                        price: String(currentItem.price ?? 0),
                        reorderLevel: String(currentItem.reorderLevel ?? 0)
                    });
                    setIsCustomUnit(!sanitizedUnitOptions.some(option => option.toLowerCase() === existingUnit.toLowerCase()));
                } else {
                    setItem({
                        ...defaultItemState(),
                        sku: `SKU-${Date.now()}`
                    });
                    setIsCustomUnit(false);
                }
            }, [currentItem, preferredUnit, sanitizedUnitOptions]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                const uppercaseFields = ['sku', 'name', 'brand', 'location'];
                setItem(prev => ({ ...prev, [name]: uppercaseFields.includes(name) ? value.toUpperCase() : value }));
            };

            const handleUnitSelect = (e) => {
                const { value } = e.target;
                if (value === '__custom__') {
                    setIsCustomUnit(true);
                    setItem(prev => ({ ...prev, unit: '', issuingUnit: '' }));
                    return;
                }
                setIsCustomUnit(false);
                const normalized = normalizeUnitValue(value) || preferredUnit;
                setItem(prev => ({
                    ...prev,
                    unit: normalized,
                    issuingUnit: normalized,
                    issuingUnits: ensurePreferredUnitList([normalized, ...(prev.issuingUnits || [])])
                }));
            };

            const handleCustomUnitChange = (e) => {
                const value = normalizeUnitValue(e.target.value);
                setItem(prev => ({ ...prev, unit: value, issuingUnit: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!item.name || !item.sku) {
                    setNotification({type: 'error', message: 'SKU and Name are required.'});
                    return;
                }
                setIsSaving(true);
                try {
                    const rawUnit = item.unit && item.unit.trim() ? item.unit.trim() : 'PC/s';
                    const normalizedUnit = normalizeUnitValue(rawUnit) || 'PC/s';
                    const issuingUnitsList = Array.isArray(item.issuingUnits) ? item.issuingUnits : [];
                    const normalizedIssuingUnits = ensurePreferredUnitList([normalizedUnit, ...issuingUnitsList]);
                    await onSave({
                        ...item,
                        unit: normalizedUnit,
                        issuingUnit: normalizedUnit,
                        issuingUnits: normalizedIssuingUnits,
                        qty: Number(item.qty || 0),
                        price: parseFloat(item.price || 0),
                        reorderLevel: Number(item.reorderLevel || 0)
                    });
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h2 className="text-2xl font-bold text-gray-800">{currentItem ? 'Edit Item' : 'Add New Item'}</h2>
                    <div><label className="block text-sm font-medium">SKU</label><input type="text" name="sku" value={item.sku} onChange={handleChange} required className="w-full px-3 py-2 border rounded-lg uppercase" /></div>
                    <div><label className="block text-sm font-medium">Item Name</label><input type="text" name="name" value={item.name} onChange={handleChange} required className="w-full px-3 py-2 border rounded-lg uppercase" /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium">Brand</label><input type="text" name="brand" value={item.brand} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" /></div>
                        <div><label className="block text-sm font-medium">Location</label><input type="text" name="location" value={item.location} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" /></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium">Price</label><input type="number" step="0.01" name="price" value={item.price} onChange={handleChange} required className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium">Reorder Level</label><input type="number" name="reorderLevel" value={item.reorderLevel} onChange={handleChange} required className="w-full px-3 py-2 border rounded-lg" /></div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium">Unit of Measure</label>
                        <div className="flex flex-col sm:flex-row gap-2">
                            <select
                                value={isCustomUnit ? '__custom__' : (item.unit || preferredUnit)}
                                onChange={handleUnitSelect}
                                className="w-full sm:w-1/2 px-3 py-2 border rounded-lg"
                            >
                                {sanitizedUnitOptions.map(option => (
                                    <option key={option} value={option}>{option}</option>
                                ))}
                                <option value="__custom__">Custom...</option>
                            </select>
                            {isCustomUnit && (
                                <input
                                    type="text"
                                    value={item.unit || ''}
                                    onChange={handleCustomUnitChange}
                                    className="w-full px-3 py-2 border rounded-lg uppercase"
                                    placeholder="Enter custom unit"
                                />
                            )}
                        </div>
                        <p className="text-xs text-gray-500 mt-1">Default unit is PC/s. Use settings to manage the dropdown options or enter a custom value.</p>
                    </div>
                    { !currentItem && <div><label className="block text-sm font-medium">Initial Quantity</label><input type="number" name="qty" value={item.qty} onChange={handleChange} required className="w-full px-3 py-2 border rounded-lg" /></div>}
                    <div className="flex justify-end gap-4 pt-4">
                        <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-100 rounded-full">Cancel</button>
                        <button type="submit" disabled={isSaving} className="px-6 py-2 text-white bg-indigo-600 rounded-full disabled:bg-indigo-300 flex items-center gap-2">
                           {isSaving && <div className="w-4 h-4 border-2 border-white border-b-transparent rounded-full animate-spin"></div>}
                           {isSaving ? 'Saving...' : (currentItem ? 'Save Changes' : 'Add Item')}
                        </button>
                    </div>
                </form>
            );
        };
        
        // Modal for entering admin password
        const AdminLoginModal = ({ onLogin, onClose }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onLogin(password); };
            return (
                <Modal onClose={onClose} size="sm">
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <h2 className="text-2xl font-bold text-center text-gray-800">Admin Access</h2>
                        <div>
                            <label className="block text-sm font-medium text-gray-600">Password</label>
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" autoFocus />
                        </div>
                        <button type="submit" className="w-full px-6 py-2 text-white bg-indigo-600 rounded-full hover:bg-indigo-700">Unlock</button>
                    </form>
                </Modal>
            );
        };
        
        // Form for adjusting the stock quantity of an item
        const StockAdjustmentForm = ({ item, onAdjust, onClose, setNotification }) => {
            const [adjustment, setAdjustment] = useState(0);
            const [isSaving, setIsSaving] = useState(false);

            const handleSave = async () => {
                if (adjustment === 0) {
                     setNotification({type: 'error', message: "Adjustment value cannot be zero."});
                     return;
                }
                setIsSaving(true);
                await onAdjust(item, adjustment);
                setIsSaving(false);
            }

            return (
                <Modal onClose={onClose} size="md">
                    <div className="space-y-4">
                        <h2 className="text-2xl font-bold text-gray-800">Adjust Stock</h2>
                        <div>
                            <p className="font-medium text-lg">{item.name} <span className="text-sm text-gray-500">({item.sku})</span></p>
                            <p>Current Quantity: <span className="font-bold text-xl">{item.qty}</span></p>
                        </div>
                        <div>
                           <label className="block text-sm font-medium">Adjustment (+/-)</label>
                           <input 
                               type="number" 
                               value={adjustment} 
                               onChange={(e) => setAdjustment(Number(e.target.value))} 
                               className="w-full px-3 py-2 border rounded-lg text-center text-2xl"
                               autoFocus
                            />
                            <p className="text-sm text-gray-500 mt-2">New Quantity will be: <span className="font-bold">{item.qty + adjustment}</span></p>
                        </div>
                        <div className="flex justify-end gap-4 pt-4">
                            <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-100 rounded-full">Cancel</button>
                            <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 text-white bg-green-600 rounded-full disabled:bg-green-300 flex items-center gap-2">
                                {isSaving && <div className="w-4 h-4 border-2 border-white border-b-transparent rounded-full animate-spin"></div>}
                                {isSaving ? 'Applying...' : 'Apply Adjustment'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };
        
        // Form for changing application settings (admin pass, reorder level)
        const SettingsForm = ({ settings, onSave, onClose }) => {
            const [localSettings, setLocalSettings] = useState(() => ({
                ...settings,
                unitOptions: ensurePreferredUnitList(settings.unitOptions?.length ? settings.unitOptions : GLOBAL_UNIT_OPTIONS)
            }));
            const [isSaving, setIsSaving] = useState(false);
            const [unitDraft, setUnitDraft] = useState('');
            const [editingIndex, setEditingIndex] = useState(null);

            useEffect(() => {
                setLocalSettings(prev => ({
                    ...prev,
                    ...settings,
                    unitOptions: ensurePreferredUnitList(settings.unitOptions?.length ? settings.unitOptions : GLOBAL_UNIT_OPTIONS)
                }));
            }, [settings]);

            const normalizedUnits = useMemo(() => ensurePreferredUnitList(localSettings.unitOptions), [localSettings.unitOptions]);

            const formatUnitForStorage = (value) => {
                const trimmed = value.trim();
                if (!trimmed) return '';
                const normalizedKey = trimmed.toLowerCase();
                const canonicalMap = {
                    'pc/s': 'PC/s',
                    pcs: 'PC/s',
                    pc: 'PC/s',
                    'roll/s': 'Roll/s',
                    rolls: 'Roll/s',
                    roll: 'Roll/s',
                    'meter/s': 'Meter/s',
                    meters: 'Meter/s',
                    meter: 'Meter/s',
                    'set/s': 'Set/s',
                    sets: 'Set/s',
                    set: 'Set/s'
                };
                if (canonicalMap[normalizedKey]) {
                    return canonicalMap[normalizedKey];
                }
                if (normalizedKey === 'assy') return 'Assy';
                if (normalizedKey === 'box') return 'Box';
                if (normalizedKey === 'length') return 'Length';
                if (trimmed.includes('/')) {
                    return trimmed
                        .split('/')
                        .map((part, index) => index === 0
                            ? part.charAt(0).toUpperCase() + part.slice(1).toLowerCase()
                            : part.toLowerCase())
                        .join('/');
                }
                if (trimmed.length <= 4) {
                    return trimmed.toUpperCase();
                }
                return trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
            };

            const handleChange = (e) => setLocalSettings(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleUnitSubmit = (e) => {
                e.preventDefault();
                const formatted = formatUnitForStorage(unitDraft);
                if (!formatted) {
                    return;
                }
                setLocalSettings(prev => {
                    const current = Array.isArray(prev.unitOptions) ? [...prev.unitOptions] : [];
                    if (editingIndex !== null) {
                        current[editingIndex] = formatted;
                    } else if (!current.some(unit => unit.toLowerCase() === formatted.toLowerCase())) {
                        current.push(formatted);
                    }
                    return {
                        ...prev,
                        unitOptions: ensurePreferredUnitList(current)
                    };
                });
                setUnitDraft('');
                setEditingIndex(null);
            };

            const handleEditUnit = (index) => {
                setEditingIndex(index);
                setUnitDraft(normalizedUnits[index] || '');
            };

            const handleDeleteUnit = (index) => {
                setLocalSettings(prev => {
                    const current = Array.isArray(prev.unitOptions) ? prev.unitOptions.filter((_, idx) => idx !== index) : [];
                    return {
                        ...prev,
                        unitOptions: ensurePreferredUnitList(current)
                    };
                });
                if (editingIndex === index) {
                    setEditingIndex(null);
                    setUnitDraft('');
                }
            };

            const handleCancelUnitEdit = () => {
                setEditingIndex(null);
                setUnitDraft('');
            };

            const handleResetUnits = () => {
                setLocalSettings(prev => ({
                    ...prev,
                    unitOptions: [...DEFAULT_ISSUING_UNITS]
                }));
                setEditingIndex(null);
                setUnitDraft('');
            };

            const handleSave = async () => {
                setIsSaving(true);
                await onSave({
                    ...localSettings,
                    unitOptions: ensurePreferredUnitList(localSettings.unitOptions)
                });
                setIsSaving(false);
            };

            return (
                <Modal onClose={onClose} size="lg">
                    <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-gray-800">Application Settings</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium">Admin Password</label>
                                <input type="password" name="adminPass" value={localSettings.adminPass} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg" />
                                <p className="text-xs text-gray-500 mt-1">Set a new password for accessing admin functions.</p>
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Default Reorder Level</label>
                                <input type="number" name="reorderLevel" value={localSettings.reorderLevel} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg" />
                                <p className="text-xs text-gray-500 mt-1">Global alert level for low stock if not set per-item.</p>
                            </div>
                        </div>
                        <div className="space-y-3 p-4 border rounded-lg bg-gray-50">
                            <div className="flex items-center justify-between gap-2">
                                <h3 className="font-bold text-gray-800">Units of Measure</h3>
                                <button type="button" onClick={handleResetUnits} className="text-xs font-semibold text-indigo-600 hover:text-indigo-500">Reset to defaults</button>
                            </div>
                            <p className="text-xs text-gray-500">Customize the dropdown values used when selecting units. PC/s will always be available.</p>
                            <form onSubmit={handleUnitSubmit} className="flex flex-col sm:flex-row gap-2">
                                <input
                                    type="text"
                                    value={unitDraft}
                                    onChange={(e) => setUnitDraft(e.target.value)}
                                    className="flex-1 px-3 py-2 border rounded-lg uppercase"
                                    placeholder="e.g., BOX"
                                />
                                <div className="flex gap-2">
                                    {editingIndex !== null && (
                                        <button type="button" onClick={handleCancelUnitEdit} className="px-4 py-2 bg-gray-200 rounded-lg text-sm">Cancel</button>
                                    )}
                                    <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">
                                        {editingIndex !== null ? 'Save Unit' : 'Add Unit'}
                                    </button>
                                </div>
                            </form>
                            <ul className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                {normalizedUnits.map((unit, index) => (
                                    <li key={unit} className="flex items-center justify-between bg-white border rounded-lg px-3 py-2 text-sm">
                                        <span className="font-medium text-gray-700">{unit}</span>
                                        <div className="flex items-center gap-2">
                                            <button type="button" onClick={() => handleEditUnit(index)} className="text-xs text-indigo-600 hover:underline">Edit</button>
                                            <button
                                                type="button"
                                                onClick={() => handleDeleteUnit(index)}
                                                className="text-xs text-red-600 hover:underline disabled:text-gray-300 disabled:no-underline"
                                                disabled={normalizedUnits.length <= 1}
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </li>
                                ))}
                                {normalizedUnits.length === 0 && <li className="text-xs text-gray-500">No units configured.</li>}
                            </ul>
                        </div>
                        <div className="flex justify-end gap-4 pt-4 border-t">
                            <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-100 rounded-full">Cancel</button>
                            <button type="button" onClick={handleSave} disabled={isSaving} className="px-6 py-2 text-white bg-indigo-600 rounded-full disabled:bg-indigo-300 flex items-center gap-2">
                                {isSaving && <div className="w-4 h-4 border-2 border-white border-b-transparent rounded-full animate-spin"></div>}
                                {isSaving ? 'Saving...' : 'Save Settings'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // Form for managing project sites
        const SiteManagementForm = ({ sites, onSave, onClose, setNotification, onFinishSite, onReactivateSite }) => {
            const [editingSite, setEditingSite] = useState(null);
            const [formData, setFormData] = useState({ name: '', drPrefix: '' });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if (editingSite) {
                    setFormData(editingSite);
                } else {
                    setFormData({ name: '', drPrefix: '' });
                }
            }, [editingSite]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value.toUpperCase() }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.name || !formData.drPrefix) {
                    setNotification({ type: 'error', message: "Site Name and DR Prefix are required." });
                    return;
                }
                setIsSaving(true);
                await onSave(formData);
                setIsSaving(false);
                setEditingSite(null); // Reset form after saving
            };

            return (
                <Modal onClose={onClose} size="lg">
                    <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-gray-800">Manage Sites</h2>
                        <form onSubmit={handleSubmit} className="p-4 border rounded-lg bg-gray-50 space-y-4">
                            <h3 className="font-bold">{editingSite ? 'Edit Site' : 'Add New Site'}</h3>
                            <div className="flex gap-2 items-end">
                                <div className="flex-grow">
                                    <label className="text-sm font-medium">Site Name</label>
                                    <input type="text" name="name" value={formData.name} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" />
                                </div>
                                <div className="flex-grow">
                                    <label className="text-sm font-medium">DR Prefix</label>
                                    <input type="text" name="drPrefix" value={formData.drPrefix} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" />
                                </div>
                            </div>
                            <div className="flex justify-end gap-2">
                                {editingSite && <button type="button" onClick={() => setEditingSite(null)} className="px-4 h-10 bg-gray-200 rounded-lg">Cancel</button>}
                                <button type="submit" disabled={isSaving} className="px-4 h-10 text-white bg-indigo-600 rounded-lg flex items-center justify-center disabled:bg-indigo-300">
                                    {isSaving ? '...' : (editingSite ? 'Save Changes' : 'Add Site')}
                                </button>
                            </div>
                        </form>
                        <div className="border-t pt-4">
                            <h3 className="font-bold mb-2">Existing Sites</h3>
                            <ul className="space-y-2 h-48 overflow-y-auto pr-2">
                                {sites.length > 0 ? sites.map(s => (
                                    <li key={s.id} className={`p-3 rounded-lg flex justify-between items-center ${s.status === 'Finished' ? 'bg-gray-200' : 'bg-gray-100'}`}>
                                        <div>
                                            <span className={`font-medium ${s.status === 'Finished' ? 'text-gray-500' : ''}`}>{s.name}</span>
                                            <span className={`ml-4 font-mono ${s.status === 'Finished' ? 'text-gray-400' : 'text-gray-500'}`}>{s.drPrefix} / Last DR: {s.lastDrNumber || 0}</span>
                                            {s.status === 'Finished' && <span className="ml-4 text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">FINISHED</span>}
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <button onClick={() => setEditingSite(s)} disabled={s.status === 'Finished'} className="text-sm text-indigo-600 hover:underline disabled:text-gray-400 disabled:no-underline">Edit</button>
                                            {s.status === 'Finished' ? (
                                                <button onClick={() => onReactivateSite(s)} className="text-sm text-green-600 hover:underline">Re-activate</button>
                                            ) : (
                                                <button onClick={() => onFinishSite(s)} className="text-sm text-blue-600 hover:underline">Mark as Finished</button>
                                            )}
                                        </div>
                                    </li>
                                )) : <p className="text-gray-500">No sites configured.</p>}
                            </ul>
                        </div>
                        <div className="flex justify-end">
                            <button onClick={onClose} className="px-6 py-2 bg-gray-200 rounded-full mt-4">Done</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const ManualReceiptModal = ({
            sites,
            unitOptions = [],
            onFinalize,
            onClose,
            setNotification,
            initialData = null,
            onDraftChange = () => {}
        }) => {
            const normalizedUnits = useMemo(() => ensurePreferredUnitList(unitOptions), [unitOptions]);

            const defaultUnit = normalizedUnits[0] || 'PC/s';

            const buildRow = useCallback(() => ({
                id: `manual-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                name: '',
                dispatchQty: 1,
                unit: defaultUnit,
                price: 0,
                isManual: true
            }), [defaultUnit]);

            const normalizeManualItem = useCallback((item) => ({
                id: item.id || `manual-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                name: (item.name || '').toUpperCase(),
                dispatchQty: Math.max(0, Number(item.dispatchQty || item.requestedQty || 0)),
                unit: normalizeUnitValue(item.unit || item.issuingUnit || defaultUnit) || defaultUnit,
                price: Math.max(0, Number(item.price || 0)),
                isManual: true
            }), [defaultUnit]);

            const [siteId, setSiteId] = useState(initialData?.siteId || '');
            const [customerName, setCustomerName] = useState(initialData?.customerName || '');
            const [address, setAddress] = useState(initialData?.address || '');
            const [poNumber, setPoNumber] = useState(initialData?.poNumber || '');
            const [remarks, setRemarks] = useState(initialData?.remarks || '');
            const [showPrice, setShowPrice] = useState(initialData?.showPrice ?? true);
            const [items, setItems] = useState(() => {
                if (initialData?.items?.length) {
                    return initialData.items.map(normalizeManualItem);
                }
                return [buildRow()];
            });
            const draftSnapshotRef = useRef('null');

            useEffect(() => {
                if (initialData) {
                    const sanitizedItems = initialData.items?.length ? initialData.items.map(normalizeManualItem) : [buildRow()];
                    setSiteId(initialData.siteId || '');
                    setCustomerName(initialData.customerName || '');
                    setAddress(initialData.address || '');
                    setPoNumber(initialData.poNumber || '');
                    setRemarks(initialData.remarks || '');
                    setShowPrice(initialData.showPrice ?? true);
                    setItems(sanitizedItems);
                    draftSnapshotRef.current = JSON.stringify({
                        siteId: initialData.siteId || '',
                        customerName: initialData.customerName || '',
                        address: initialData.address || '',
                        poNumber: initialData.poNumber || '',
                        remarks: initialData.remarks || '',
                        items: sanitizedItems,
                        showPrice: initialData.showPrice ?? true,
                        origin: 'manual'
                    });
                } else {
                    setSiteId('');
                    setCustomerName('');
                    setAddress('');
                    setPoNumber('');
                    setRemarks('');
                    setShowPrice(true);
                    setItems([buildRow()]);
                    draftSnapshotRef.current = 'null';
                }
            }, [initialData, buildRow, normalizeManualItem]);

            useEffect(() => {
                const normalizedItems = items.map(normalizeManualItem);
                const hasItemChanges = normalizedItems.some(item => {
                    const hasName = item.name.trim().length > 0;
                    const qtyChanged = Number(item.dispatchQty) !== 1 && Number(item.dispatchQty) > 0;
                    const hasPrice = Number(item.price) > 0;
                    return hasName || hasPrice || qtyChanged;
                });
                const hasContent = Boolean(
                    siteId ||
                    customerName ||
                    address ||
                    poNumber ||
                    remarks ||
                    hasItemChanges
                );

                if (!hasContent) {
                    if (draftSnapshotRef.current !== 'null') {
                        draftSnapshotRef.current = 'null';
                        onDraftChange(null);
                    }
                    return;
                }

                const draftPayload = {
                    siteId,
                    customerName,
                    address,
                    poNumber,
                    remarks,
                    items: normalizedItems,
                    showPrice,
                    origin: 'manual'
                };

                const serialized = JSON.stringify(draftPayload);
                if (draftSnapshotRef.current !== serialized) {
                    draftSnapshotRef.current = serialized;
                    onDraftChange(draftPayload);
                }
            }, [siteId, customerName, address, poNumber, remarks, items, showPrice, normalizeManualItem, onDraftChange]);

            const handleReset = () => {
                setSiteId('');
                setCustomerName('');
                setAddress('');
                setPoNumber('');
                setRemarks('');
                setShowPrice(true);
                setItems([buildRow()]);
                draftSnapshotRef.current = 'null';
                onDraftChange(null);
            };

            const handleUppercaseChange = (setter) => (e) => setter(e.target.value.toUpperCase());

            const handleItemChange = (id, field, value) => {
                setItems(prev => prev.map(item => {
                    if (item.id !== id) return item;
                    if (field === 'dispatchQty') {
                        const qty = Math.max(0, Number(value));
                        return { ...item, dispatchQty: qty };
                    }
                    if (field === 'price') {
                        const price = Math.max(0, Number(value));
                        return { ...item, price };
                    }
                    if (field === 'unit') {
                        return { ...item, unit: normalizeUnitValue(value) || defaultUnit };
                    }
                    if (field === 'name') {
                        return { ...item, name: value.toUpperCase() };
                    }
                    return item;
                }));
            };

            const handleAddRow = () => setItems(prev => [...prev, buildRow()]);
            const handleRemoveRow = (id) => setItems(prev => prev.filter(item => item.id !== id));

            const handleFinalize = () => {
                if (!siteId) {
                    setNotification?.({ type: 'error', message: 'Please select a site before continuing.' });
                    return;
                }

                const cleanedItems = items
                    .map(normalizeManualItem)
                    .filter(item => item.name.trim() && item.dispatchQty > 0);

                if (cleanedItems.length === 0) {
                    setNotification?.({ type: 'error', message: 'Add at least one manual item with a quantity greater than zero.' });
                    return;
                }

                const receiptData = {
                    siteId,
                    customerName,
                    address,
                    poNumber,
                    remarks,
                    items: cleanedItems,
                    showPrice,
                    origin: 'manual'
                };

                draftSnapshotRef.current = JSON.stringify(receiptData);
                onDraftChange(receiptData);
                onFinalize(receiptData);
            };

            return (
                <Modal onClose={onClose} size="7xl">
                    <div className="space-y-6 max-h-[80vh] overflow-y-auto pr-1">
                        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            <h2 className="text-2xl font-bold text-gray-800">Manual Delivery Receipt</h2>
                            <div className="flex flex-wrap gap-2">
                                <button
                                    type="button"
                                    onClick={handleReset}
                                    className="px-4 py-2 rounded-full text-sm font-semibold bg-white border border-gray-200 text-gray-700 hover:bg-gray-100"
                                >
                                    üóëÔ∏è Start New Draft
                                </button>
                                <button
                                    type="button"
                                    onClick={handleAddRow}
                                    className="px-4 py-2 rounded-full text-sm font-semibold bg-amber-500 text-white hover:bg-amber-600"
                                >
                                    ‚ûï Add Manual Item
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select value={siteId} onChange={e => setSiteId(e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- Select Site --</option>
                                {sites.filter(s => s.status !== 'Finished').map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <input type="text" placeholder="Customer Name" value={customerName} onChange={handleUppercaseChange(setCustomerName)} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            <input type="text" placeholder="PO Number (Optional)" value={poNumber} onChange={handleUppercaseChange(setPoNumber)} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            <input type="text" placeholder="Address" value={address} onChange={handleUppercaseChange(setAddress)} className="w-full px-3 py-2 border rounded-lg uppercase md:col-span-2" />
                        </div>

                        <div className="border rounded-lg bg-white">
                            <div className="max-h-[40vh] overflow-y-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 bg-gray-100 z-10">
                                        <tr>
                                            <th className="p-3 w-20">Qty</th>
                                            <th className="p-3 w-32">Unit</th>
                                            <th className="p-3">Description</th>
                                            <th className="p-3 w-32">Unit Price</th>
                                            <th className="p-3 w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {items.map(item => (
                                            <tr key={item.id} className="border-b">
                                                <td className="p-2 align-top">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        value={item.dispatchQty}
                                                        onChange={(e) => handleItemChange(item.id, 'dispatchQty', e.target.value)}
                                                        className="w-full px-2 py-1 border rounded"
                                                    />
                                                </td>
                                                <td className="p-2 align-top">
                                                    <select
                                                        value={item.unit}
                                                        onChange={(e) => handleItemChange(item.id, 'unit', e.target.value)}
                                                        className="w-full px-2 py-1 border rounded"
                                                    >
                                                        {normalizedUnits.map(option => (
                                                            <option key={option} value={option}>{option}</option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td className="p-2">
                                                    <textarea
                                                        value={item.name}
                                                        onChange={(e) => handleItemChange(item.id, 'name', e.target.value)}
                                                        className="w-full px-2 py-1 border rounded resize-none h-20 uppercase"
                                                    ></textarea>
                                                </td>
                                                <td className="p-2 align-top">
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        step="0.01"
                                                        value={item.price}
                                                        onChange={(e) => handleItemChange(item.id, 'price', e.target.value)}
                                                        className="w-full px-2 py-1 border rounded"
                                                    />
                                                </td>
                                                <td className="p-2 align-top text-right">
                                                    <button onClick={() => handleRemoveRow(item.id)} className="text-red-500 hover:text-red-700 font-semibold">Remove</button>
                                                </td>
                                            </tr>
                                        ))}
                                        {items.length === 0 && (
                                            <tr>
                                                <td colSpan="5" className="p-6 text-center text-gray-500">No manual items added yet.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <textarea
                            placeholder="Remarks (Optional)"
                            value={remarks}
                            onChange={handleUppercaseChange(setRemarks)}
                            className="w-full px-3 py-2 border rounded-lg uppercase min-h-[80px]"
                        ></textarea>
                        <label className="flex items-center gap-2 text-sm bg-gray-100 px-3 py-2 rounded-lg">
                            <input type="checkbox" checked={showPrice} onChange={() => setShowPrice(!showPrice)} /> Show price & totals on preview
                        </label>

                        <div className="flex justify-end gap-3 pt-4 border-t">
                            <button onClick={onClose} className="px-6 py-2 bg-gray-200 rounded-full">Cancel</button>
                            <button onClick={handleFinalize} className="px-6 py-2 bg-teal-600 text-white rounded-full hover:bg-teal-700">Preview & Finalize</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // Form for creating a new delivery receipt
        const DeliveryReceiptForm = ({ inventory, sites, onFinalize, onClose, setNotification, initialData = null, onDraftChange = () => {} }) => {
            const [siteId, setSiteId] = useState(initialData?.siteId || '');
            const [customerName, setCustomerName] = useState(initialData?.customerName || '');
            const [address, setAddress] = useState(initialData?.address || '');
            const [poNumber, setPoNumber] = useState(initialData?.poNumber || '');
            const [remarks, setRemarks] = useState(initialData?.remarks || '');
            const [cart, setCart] = useState(initialData?.items || []);
            const [searchTerm, setSearchTerm] = useState('');
            const [showPrice, setShowPrice] = useState(initialData?.showPrice ?? true);
            const [selectionState, setSelectionState] = useState({});
            const draftSnapshotRef = useRef('null');

            useEffect(() => {
                if (initialData) {
                    const sanitizedItems = (initialData.items || []).map(item => ({
                        ...item,
                        unit: normalizeUnitValue(item.unit) || getPrimaryIssuingUnit(item)
                    }));
                    setSiteId(initialData.siteId || '');
                    setCustomerName(initialData.customerName || '');
                    setAddress(initialData.address || '');
                    setPoNumber(initialData.poNumber || '');
                    setRemarks(initialData.remarks || '');
                    setCart(sanitizedItems);
                    setShowPrice(initialData.showPrice ?? true);
                    draftSnapshotRef.current = JSON.stringify({
                        siteId: initialData.siteId || '',
                        customerName: initialData.customerName || '',
                        address: initialData.address || '',
                        poNumber: initialData.poNumber || '',
                        remarks: initialData.remarks || '',
                        items: sanitizedItems,
                        showPrice: initialData.showPrice ?? true,
                        origin: 'inventory'
                    });
                } else {
                    setSiteId('');
                    setCustomerName('');
                    setAddress('');
                    setPoNumber('');
                    setRemarks('');
                    setCart([]);
                    setShowPrice(true);
                    draftSnapshotRef.current = 'null';
                }
                setSelectionState({});
            }, [initialData]);

            useEffect(() => {
                const normalizedCart = cart.map(item => ({
                    ...item,
                    unit: normalizeUnitValue(item.unit) || getPrimaryIssuingUnit(item)
                }));

                const hasContent = Boolean(
                    siteId ||
                    customerName ||
                    address ||
                    poNumber ||
                    remarks ||
                    normalizedCart.length > 0
                );

                if (!hasContent) {
                    if (draftSnapshotRef.current !== 'null') {
                        draftSnapshotRef.current = 'null';
                        onDraftChange(null);
                    }
                    return;
                }

                const draftPayload = {
                    siteId,
                    customerName,
                    address,
                    poNumber,
                    remarks,
                    items: normalizedCart,
                    showPrice,
                    origin: 'inventory'
                };

                const serialized = JSON.stringify(draftPayload);
                if (draftSnapshotRef.current !== serialized) {
                    draftSnapshotRef.current = serialized;
                    onDraftChange(draftPayload);
                }
            }, [siteId, customerName, address, poNumber, remarks, cart, showPrice, onDraftChange]);

            const handleResetForm = () => {
                setSiteId('');
                setCustomerName('');
                setAddress('');
                setPoNumber('');
                setRemarks('');
                setCart([]);
                setShowPrice(true);
                setSelectionState({});
                draftSnapshotRef.current = 'null';
                onDraftChange(null);
            };

            const filteredInventory = useMemo(() => {
                const term = searchTerm.trim().toLowerCase();
                if (!term) return inventory;
                return inventory.filter(i => {
                    const name = (i.name || '').toLowerCase();
                    const sku = (i.sku || '').toLowerCase();
                    return name.includes(term) || sku.includes(term);
                });
            }, [inventory, searchTerm]);

            const handleTextChange = (setter) => (e) => setter(e.target.value.toUpperCase());

            const getSelectionForItem = (item) => {
                const options = resolveUnitOptions(item);
                const defaults = { qty: 1, unit: options[0] };
                return { ...defaults, ...(selectionState[item.id] || {}) };
            };

            const updateSelection = (itemId, field, value) => {
                const nextValue = field === 'qty'
                    ? value.replace(/[^0-9.]/g, '')
                    : normalizeUnitValue(value) || value;
                setSelectionState(prev => ({
                    ...prev,
                    [itemId]: {
                        ...prev[itemId],
                        [field]: nextValue
                    }
                }));
            };

            const addToCart = (item) => {
                setCart(prev => {
                    if (prev.find(i => i.id === item.id)) {
                        setNotification({ type: 'info', message: `${item.name} is already in the list.` });
                        return prev;
                    }

                    const selection = getSelectionForItem(item);
                    const parsedQty = Math.max(0, Number(selection.qty || 0));
                    if (!parsedQty) {
                        setNotification({ type: 'error', message: 'Please enter a quantity greater than zero before adding.' });
                        return prev;
                    }

                    const inventoryItem = inventory.find(i => i.id === item.id);
                    if (inventoryItem && parsedQty > Number(inventoryItem.qty)) {
                        setNotification({ type: 'error', message: `Cannot dispatch more than ${inventoryItem.qty} units of ${inventoryItem.name}.` });
                        return prev;
                    }

                    const nextUnit = normalizeUnitValue(selection.unit || getPrimaryIssuingUnit(item)) || getPrimaryIssuingUnit(item);
                    return [...prev, { ...item, dispatchQty: parsedQty, unit: nextUnit }];
                });
            };

            const updateCartQty = (id, qty) => {
                const inventoryItem = inventory.find(i => i.id === id);
                const newQty = Math.max(0, Number(qty));
                if (inventoryItem && newQty > Number(inventoryItem.qty)) {
                    setNotification({ type: 'error', message: `Cannot dispatch more than ${inventoryItem.qty} units of ${inventoryItem.name}.` });
                    setCart(prev => prev.map(i => i.id === id ? { ...i, dispatchQty: Number(inventoryItem.qty) } : i));
                    return;
                }
                setCart(prev => prev.map(i => i.id === id ? { ...i, dispatchQty: newQty } : i));
            };

            const updateCartUnit = (id, unit) => {
                const normalized = normalizeUnitValue(unit) || getPrimaryIssuingUnit(cart.find(i => i.id === id) || {});
                setCart(prev => prev.map(i => i.id === id ? { ...i, unit: normalized } : i));
            };

            const removeFromCart = (id) => setCart(prev => prev.filter(i => i.id !== id));

            const handleFinalize = () => {
                const finalCart = cart.filter(i => i.dispatchQty > 0);
                if (!siteId) { setNotification({ type: 'error', message: 'Please select a site.' }); return; }
                if (finalCart.length === 0) { setNotification({ type: 'error', message: 'Please add at least one item to the receipt.' }); return; }

                const normalizedCart = finalCart.map(item => ({
                    ...item,
                    unit: normalizeUnitValue(item.unit) || getPrimaryIssuingUnit(item)
                }));

                const receiptData = { siteId, customerName, address, poNumber, remarks, items: normalizedCart, showPrice };
                draftSnapshotRef.current = JSON.stringify({ ...receiptData, origin: 'inventory' });
                onDraftChange(receiptData);
                onFinalize(receiptData);
            }

            return (
                <Modal onClose={onClose} size="7xl">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Item List & Header */}
                        <div className="lg:col-span-2 space-y-4">
                        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            <h2 className="text-2xl font-bold text-gray-800">Create Delivery Receipt</h2>
                            <div className="flex flex-wrap gap-2">
                                <button
                                    type="button"
                                    onClick={handleResetForm}
                                    className="px-4 py-2 rounded-full text-sm font-semibold bg-white border border-gray-200 text-gray-700 hover:bg-gray-100"
                                >
                                    üîÑ Reset Form
                                </button>
                            </div>
                        </div>
                             <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                 <select value={siteId} onChange={e => setSiteId(e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                                     <option value="">-- Select Site --</option>
                                     {sites.filter(s => s.status !== 'Finished').map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                 </select>
                                 <input type="text" placeholder="Customer Name" value={customerName} onChange={handleTextChange(setCustomerName)} className="w-full px-3 py-2 border rounded-lg uppercase" />
                                 <input type="text" placeholder="PO Number (Optional)" value={poNumber} onChange={handleTextChange(setPoNumber)} className="w-full px-3 py-2 border rounded-lg uppercase" />
                                 <input type="text" placeholder="Address" value={address} onChange={handleTextChange(setAddress)} className="w-full px-3 py-2 border rounded-lg uppercase md:col-span-2" />
                             </div>
                            <input type="text" placeholder="Search for items to add..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                            <div className="h-[40vh] overflow-y-auto border rounded-lg">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 bg-gray-50 z-10">
                                        <tr>
                                            <th className="p-2">Name</th>
                                            <th className="p-2">Issuing Unit</th>
                                            <th className="p-2 w-48">Quantity</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredInventory.map(item => {
                                            const selection = getSelectionForItem(item);
                                            const unitOptions = resolveUnitOptions(item);
                                            const inCart = cart.some(c => c.id === item.id);
                                            return (
                                                <tr key={item.id} className="border-b">
                                                    <td className="p-2">
                                                        <div className="flex flex-col">
                                                            <span>{item.name}</span>
                                                            <span className="text-xs text-gray-400">({item.sku})</span>
                                                            <span className="text-xs text-gray-500">Stock: {item.qty}</span>
                                                        </div>
                                                    </td>
                                                    <td className="p-2">
                                                        <select
                                                            value={selection.unit}
                                                            onChange={(e) => updateSelection(item.id, 'unit', e.target.value)}
                                                            className="w-full px-2 py-1 border rounded"
                                                            disabled={inCart}
                                                        >
                                                            {unitOptions.map(option => (
                                                                <option key={option} value={option}>{option}</option>
                                                            ))}
                                                        </select>
                                                    </td>
                                                    <td className="p-2">
                                                        <div className="flex items-center gap-2">
                                                            <input
                                                                type="number"
                                                                min="0"
                                                                value={selection.qty}
                                                                onChange={(e) => updateSelection(item.id, 'qty', e.target.value)}
                                                                className="w-20 p-1 border rounded"
                                                                disabled={inCart}
                                                            />
                                                            <button
                                                                onClick={() => addToCart(item)}
                                                                className="bg-teal-500 text-white px-3 py-1 text-xs rounded-full hover:bg-teal-600 disabled:bg-gray-300"
                                                                disabled={inCart}
                                                            >
                                                                {inCart ? 'Added' : 'Add'}
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Receipt Cart Column */}
                        <div className="space-y-4 bg-gray-50 p-4 rounded-lg">
                            <h3 className="text-xl font-bold text-gray-800">Items on Receipt</h3>
                            <div className="h-[40vh] overflow-y-auto border rounded-lg bg-white">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 bg-gray-100 z-10"><tr><th className="p-2">Item</th><th className="p-2 w-24">Qty</th><th className="p-2 w-32">Unit</th><th className="p-2"></th></tr></thead>
                                    <tbody>
                                        {cart.length > 0 ? cart.map(item => (
                                            <tr key={item.id} className="border-b">
                                                <td className="p-2">{item.name}</td>
                                                <td className="p-2"><input type="number" value={item.dispatchQty} onChange={e => updateCartQty(item.id, e.target.value)} className="w-20 p-1 border rounded-md" /></td>
                                                <td className="p-2">
                                                    <select value={item.unit} onChange={(e) => updateCartUnit(item.id, e.target.value)} className="w-full px-2 py-1 border rounded-md">
                                                        {resolveUnitOptions(item).map(option => (
                                                            <option key={option} value={option}>{option}</option>
                                                        ))}
                                                    </select>
                                                </td>
                                                <td className="p-2"><button onClick={() => removeFromCart(item.id)} className="text-red-500 hover:text-red-700 font-bold">X</button></td>
                                            </tr>
                                        )) : <tr><td colSpan="4" className="text-center p-8 text-gray-500">No items added.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                            <input type="text" placeholder="Remarks (Optional)" value={remarks} onChange={handleTextChange(setRemarks)} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            <div className="space-y-2 text-sm p-2 bg-gray-100 rounded-md">
                                <label className="flex items-center gap-2"><input type="checkbox" checked={showPrice} onChange={() => setShowPrice(!showPrice)} /> Show Price & Totals</label>
                            </div>
                             <div className="flex justify-end gap-2 pt-4 border-t">
                                 <button onClick={handleFinalize} disabled={cart.length === 0} className="px-6 py-2 text-white bg-teal-600 rounded-full disabled:bg-teal-300">
                                     Preview & Finalize
                                 </button>
                             </div>
                        </div>
                    </div>
                </Modal>
            );
        };
        
        // Modal for showing historical documents (DRs, Orders)
        const DocumentHistoryModal = ({ documents, onClose, openDetailView, title, actions = [], type, template }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [viewingReceipt, setViewingReceipt] = useState(null);

            const filteredDocuments = useMemo(() => {
                const baseDocs = documents || [];
                if (type !== 'dr_manager') return baseDocs;
                const term = searchTerm.trim().toLowerCase();
                if (!term) return baseDocs;
                return baseDocs.filter(doc => {
                    const number = (doc.drNumber || doc.orderNumber || '').toLowerCase();
                    const identifier = (doc.customerName || doc.requestedBy || '').toLowerCase();
                    const siteName = (doc.siteName || '').toLowerCase();
                    const dateTokens = formatDateForSearch(doc.createdAt);
                    return (
                        number.includes(term) ||
                        identifier.includes(term) ||
                        siteName.includes(term) ||
                        (dateTokens && dateTokens.includes(term))
                    );
                });
            }, [documents, searchTerm, type]);

            const groupedDocuments = useMemo(() => {
                const source = type === 'dr_manager' ? filteredDocuments : (documents || []);
                if (!source.length) return {};
                if (type !== 'dr_manager') {
                    return { 'All': source };
                }
                return source.reduce((acc, doc) => {
                    const key = doc.siteName || 'Uncategorized';
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(doc);
                    return acc;
                }, {});
            }, [filteredDocuments, documents, type]);

            const handleView = (doc) => {
                if (type === 'dr_manager') {
                    setViewingReceipt(doc);
                } else if (openDetailView) {
                    openDetailView(doc);
                }
            };

            const hasDocuments = Object.keys(groupedDocuments).length > 0;

            return (
                <Modal onClose={onClose} size="7xl">
                    <div className="space-y-4">
                        <div className="flex items-center justify-between">
                            <h2 className="text-2xl font-bold text-gray-800">{title}</h2>
                            {type === 'dr_manager' && viewingReceipt && (
                                <button onClick={() => setViewingReceipt(null)} className="px-4 py-2 text-sm rounded-full bg-gray-200 hover:bg-gray-300 no-print">Back to List</button>
                            )}
                        </div>

                        {type === 'dr_manager' && viewingReceipt ? (
                            <div className="h-[60vh] overflow-y-auto border rounded-lg p-4 bg-white">
                                <ReceiptDetailView
                                    receipt={viewingReceipt}
                                    template={template}
                                    onClose={() => setViewingReceipt(null)}
                                    renderInline={true}
                                />
                            </div>
                        ) : (
                            <>
                                {type === 'dr_manager' && (
                                    <input
                                        type="text"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full px-3 py-2 border rounded-lg"
                                        placeholder="Search by number, site, name, or date (e.g. 2024-03-18)"
                                    />
                                )}
                                <div className="h-[60vh] overflow-y-auto border rounded-lg p-4">
                                    {hasDocuments ? (
                                        Object.entries(groupedDocuments).map(([groupName, docs]) => (
                                            <div key={groupName} className="mb-8">
                                                {type === 'dr_manager' && <h3 className="text-xl font-bold text-gray-700 mb-2 p-2 bg-gray-100 rounded-md">{groupName}</h3>}
                                                <table className="w-full text-left">
                                                    <thead className="sticky top-0 bg-gray-50 z-10">
                                                        <tr>
                                                            <th className="p-3">Number</th>
                                                            <th className="p-3">Date</th>
                                                            <th className="p-3">Identifier</th>
                                                            <th className="p-3">Items</th>
                                                            <th className="p-3">Status</th>
                                                            <th className="p-3 text-right">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {docs.map(doc => {
                                                            const getStatusClass = (status) => {
                                                                if (status === 'Voided') return 'text-red-500 bg-red-100';
                                                                if (status === 'Finished') return 'text-blue-500 bg-blue-100';
                                                                if (status === 'Completed') return 'text-green-500 bg-green-100';
                                                                if (status === 'Pending') return 'text-yellow-600 bg-yellow-100';
                                                                return 'text-gray-500 bg-gray-100';
                                                            }
                                                            return (
                                                             <tr key={doc.id} className="border-b hover:bg-gray-50">
                                                                 <td className="p-3 font-mono">{doc.drNumber || doc.orderNumber}</td>
                                                                 <td className="p-3">{doc.createdAt?.toDate().toLocaleDateString()}</td>
                                                                 <td className="p-3">{doc.customerName || doc.requestedBy || "N/A"}</td>
                                                                 <td className="p-3">{doc.items.length}</td>
                                                                 <td className="p-3">
                                                                     <span className={`px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(doc.status)}`}>
                                                                         {doc.status || 'Active'}
                                                                     </span>
                                                                 </td>
                                                                 <td className="p-3 text-right">
                                                                     <div className="flex gap-2 justify-end">
                                                                         <button onClick={() => handleView(doc)} className="text-indigo-600 hover:underline text-sm">View</button>
                                                                         {actions.map(action => (
                                                                             <button key={action.label} onClick={() => action.handler(doc)} disabled={action.disabled && action.disabled(doc)} className={action.className}>{action.label}</button>
                                                                         ))}
                                                                     </div>
                                                                 </td>
                                                             </tr>
                                                            )
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="h-full flex items-center justify-center text-gray-500 italic">{type === 'dr_manager' ? 'No receipts found.' : 'No records found.'}</div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </Modal>
            )
        };
        
        // Component to display a detailed, printable receipt view
        const ReceiptDetailView = ({ receipt, onClose, template, isPreview = false, onConfirm, onCancel, onDone, confirmText, renderInline = false }) => {
            const [isSaving, setIsSaving] = useState(false);
            const [isSaved, setIsSaved] = useState(false);

            const printContent = () => {
                const printArea = document.getElementById('print-area');
                if (printArea) {
                    printArea.innerHTML = document.querySelector('.printable-area').innerHTML;
                    window.print();
                }
            };
            const totalValue = receipt.items.reduce((sum, item) => sum + ((item.dispatchQty || item.requestedQty) * item.price), 0);
            
            const effectiveTemplate = {
                title: 'DELIVERY RECEIPT', 
                logoUrl: '', 
                color: '#dc2626',
                companyName: 'Your Company LLC',
                companyAddress: '123 Business Rd, Suite 456, Business City',
                companyContact: '(123) 456-7890',
                companyEmail: 'contact@yourcompany.com',
                signatory1: 'Received by / Date', 
                signatory2: 'Issued by',
                signatory3: '',
                signatory4: '',
                ...template
            };

            const showPrice = receipt.showPrice !== false;
            
            const handleConfirm = async () => {
                setIsSaving(true);
                const success = await onConfirm();
                setIsSaving(false);
                if(success) {
                    setIsSaved(true);
                }
            };

            const content = (
                <div className="printable-area mx-auto w-full max-w-[850px] space-y-6 p-8 bg-white font-serif text-gray-900">
                    {/* Header */}
                    <div className="flex justify-between items-start border-b-2 pb-4 border-gray-700">
                        <div className="w-1/4">
                            {effectiveTemplate.logoUrl && <img src={effectiveTemplate.logoUrl} alt="Company Logo" className="max-h-24 object-contain" onError={(e) => {e.target.style.display='none'; e.target.onerror=null;}} />}
                        </div>
                        <div className="w-3/4 text-right">
                            <h1 className="text-2xl font-bold uppercase">{effectiveTemplate.companyName || 'Your Company'}</h1>
                            <p className="text-sm">{effectiveTemplate.companyAddress}</p>
                            <p className="text-sm">{effectiveTemplate.companyContact}</p>
                            <p className="text-sm">{effectiveTemplate.companyEmail}</p>
                        </div>
                    </div>

                    {/* Title */}
                    <div className="text-center my-8">
                        <h2 className="text-3xl font-bold uppercase tracking-wider">{receipt.drNumber ? effectiveTemplate.title : 'ORDER REQUEST'}</h2>
                    </div>
                    
                    {/* Customer & DR Info */}
                    <div className="grid grid-cols-2 gap-8 mb-8">
                        <div>
                            <h3 className="font-bold text-gray-500 uppercase text-sm mb-2">Deliver To:</h3>
                            <p className="font-bold">{receipt.customerName || receipt.requestedBy || 'N/A'}</p>
                            <p>{receipt.address || 'N/A'}</p>
                        </div>
                        <div className="text-right">
                            <div className="grid grid-cols-2">
                                <span className="font-bold">No.:</span>
                                <span className="text-right">{receipt.drNumber || receipt.orderNumber}</span>
                            </div>
                            <div className="grid grid-cols-2">
                                <span className="font-bold">Date:</span>
                                <span className="text-right">{receipt.createdAt?.toDate().toLocaleDateString()}</span>
                            </div>
                            {receipt.poNumber &&
                                <div className="grid grid-cols-2">
                                    <span className="font-bold">P.O. No.:</span>
                                    <span className="text-right">{receipt.poNumber}</span>
                                </div>
                            }
                            {receipt.drNumber && 
                                <div className="grid grid-cols-2">
                                    <span className="font-bold">Site:</span>
                                    <span className="text-right">{receipt.siteName}</span>
                                </div>
                            }
                        </div>
                    </div>

                    {/* Items Table */}
                    <div className="overflow-x-hidden">
                        <table className="w-full text-left text-sm table-fixed border-collapse">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="w-20 p-2 border">Qty</th>
                                    <th className="w-24 p-2 border">Unit</th>
                                    <th className="p-2 border">Description</th>
                                    {showPrice && <th className="w-32 p-2 border text-right">Unit Price</th>}
                                    {showPrice && <th className="w-32 p-2 border text-right">Total</th>}
                                </tr>
                            </thead>
                            <tbody>
                                {receipt.items.map(item => (
                                    <tr key={item.id} className="border-b">
                                        <td className="p-2 border align-top">{item.dispatchQty || item.requestedQty}</td>
                                        <td className="p-2 border align-top">{item.unit || item.issuingUnit || 'PCS'}</td>
                                        <td className="p-2 border align-top break-words">{item.name}</td>
                                        {showPrice && <td className="p-2 border text-right align-top">{formatCurrency(item.price)}</td>}
                                        {showPrice && <td className="p-2 border text-right align-top">{formatCurrency((item.dispatchQty || item.requestedQty) * item.price)}</td>}
                                    </tr>
                                ))}
                            </tbody>
                            {showPrice && (
                                <tfoot className="font-bold">
                                    <tr>
                                        <td colSpan={showPrice ? "4" : "2"} className="p-2 border text-right">Total Value:</td>
                                        <td className="p-2 border text-right">{formatCurrency(totalValue)}</td>
                                    </tr>
                                </tfoot>
                            )}
                        </table>
                    </div>

                    {receipt.remarks && <div className="mt-8"><h4 className="font-bold text-sm mb-1">Remarks:</h4><p className="text-sm border p-2 min-h-[50px]">{receipt.remarks || 'None'}</p></div>}
                    
                    <div className="mt-24 grid grid-cols-2 gap-16 text-center">
                        {effectiveTemplate.signatory1 && <div><p className="border-t pt-2 border-gray-400">{effectiveTemplate.signatory1}</p></div>}
                        {effectiveTemplate.signatory2 && <div><p className="border-t pt-2 border-gray-400">{effectiveTemplate.signatory2}</p></div>}
                        {effectiveTemplate.signatory3 && <div className="mt-16"><p className="border-t pt-2 border-gray-400">{effectiveTemplate.signatory3}</p></div>}
                        {effectiveTemplate.signatory4 && <div className="mt-16"><p className="border-t pt-2 border-gray-400">{effectiveTemplate.signatory4}</p></div>}
                    </div>
                </div>
            );

            if (isPreview) {
                 return (
                     <div className="fixed inset-0 bg-transparent z-[60] flex justify-center items-start p-4 overflow-y-auto">
                         <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl relative transform transition-all duration-300 my-8">
                             <div className="p-8">
                                 {content}
                             </div>
                             <div className="flex justify-end gap-4 p-4 border-t no-print">
                                 {isSaved ? (
                                     <>
                                         <button onClick={printContent} className="px-6 py-2 text-white bg-blue-600 rounded-full">Print</button>
                                         <button onClick={onDone} className="px-6 py-2 bg-gray-200 rounded-full">Done</button>
                                     </>
                                 ) : (
                                     <>
                                         {onCancel && <button onClick={onCancel} className="px-6 py-2 bg-gray-200 rounded-full">Go Back & Edit</button>}
                                         {onConfirm && <button onClick={handleConfirm} disabled={isSaving} className="px-6 py-2 text-white bg-teal-600 rounded-full disabled:bg-teal-300">
                                             {isSaving ? 'Saving...' : confirmText || 'Confirm'}
                                         </button>}
                                     </>
                                 )}
                             </div>
                         </div>
                     </div>
                 )
            }

            if (renderInline) {
                return (
                    <div className="space-y-4">
                        {content}
                        <div className="flex justify-end gap-4 pt-4 mt-4 border-t no-print">
                            <button onClick={onClose} className="px-6 py-2 bg-gray-100 rounded-full">Back to List</button>
                            <button onClick={printContent} className="px-6 py-2 text-white bg-blue-600 rounded-full">Print</button>
                        </div>
                    </div>
                );
            }

            return (
                <Modal onClose={onClose} size="3xl">
                    {content}
                     <div className="flex justify-end gap-4 pt-4 mt-4 border-t no-print">
                         <button onClick={onClose} className="px-6 py-2 bg-gray-100 rounded-full">Close</button>
                         <button onClick={printContent} className="px-6 py-2 text-white bg-blue-600 rounded-full">Print</button>
                     </div>
                </Modal>
            )
        };

        // Form for non-admin users to request items
        const UserOrderForm = ({ inventory, onSave, onClose, setNotification, user }) => {
            const [orderCart, setOrderCart] = useState([]);
            const [remarks, setRemarks] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const filteredInventory = useMemo(() => inventory.filter(i => 
                (i.name.toLowerCase().includes(searchTerm.toLowerCase()) || i.sku.toLowerCase().includes(searchTerm.toLowerCase()))
            ), [inventory, searchTerm]);
            
            const handleUppercaseChange = (setter) => (e) => setter(e.target.value.toUpperCase());

            const addToCart = (item) => {
                setOrderCart(prev => {
                    if (prev.find(i => i.id === item.id)) {
                        setNotification({ type: 'info', message: `${item.name} is already in the cart.` });
                        return prev;
                    }
                    return [...prev, { ...item, requestedQty: 1 }];
                });
            };
            
            const updateCartQty = (id, qty) => setOrderCart(prev => prev.map(i => i.id === id ? { ...i, requestedQty: Math.max(0, Number(qty)) } : i));
            const removeFromCart = (id) => setOrderCart(prev => prev.filter(i => i.id !== id));

            const handleSave = async () => {
                const finalCart = orderCart.filter(i => i.requestedQty > 0);
                if (finalCart.length === 0) { setNotification({type: 'error', message: 'Please add at least one item with a quantity greater than zero.'}); return; }
                
                setIsSaving(true);
                const orderData = {
                    requestedBy: user.isAnonymous ? `User (${user.uid.substring(0,6)})` : user.email,
                    remarks,
                    items: finalCart
                };
                await onSave(orderData);
                setIsSaving(false);
            };

            return (
                <Modal onClose={onClose} size="7xl">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Item List Column */}
                        <div className="lg:col-span-2 space-y-4">
                            <h2 className="text-2xl font-bold text-gray-800">Create New Order Request</h2>
                            <input type="text" placeholder="Search for items to add..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                            <div className="h-[50vh] overflow-y-auto border rounded-lg">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 bg-gray-50 z-10">
                                        <tr>
                                            <th className="p-2">Name</th>
                                            <th className="p-2">Stock</th>
                                            <th className="p-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredInventory.map(item => (
                                            <tr key={item.id} className="border-b">
                                                <td className="p-2">{item.name} <span className="text-xs text-gray-400">({item.sku})</span></td>
                                                <td className="p-2">{item.qty}</td>
                                                <td className="p-2 text-right">
                                                    <button onClick={() => addToCart(item)} className="bg-blue-500 text-white px-3 py-1 text-xs rounded-full hover:bg-blue-600 disabled:bg-gray-300" disabled={orderCart.some(c => c.id === item.id)}>
                                                        {orderCart.some(c => c.id === item.id) ? 'Added' : 'Add'}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Order Cart Column */}
                        <div className="space-y-4 bg-gray-50 p-4 rounded-lg">
                             <h3 className="text-xl font-bold text-gray-800">Your Order Cart</h3>
                            <div className="h-[40vh] overflow-y-auto border rounded-lg bg-white">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 bg-gray-100 z-10"><tr><th className="p-2">Item</th><th className="p-2 w-24">Qty</th><th className="p-2"></th></tr></thead>
                                    <tbody>
                                        {orderCart.length > 0 ? orderCart.map(item => (
                                            <tr key={item.id} className="border-b">
                                                <td className="p-2">{item.name}</td>
                                                <td className="p-2"><input type="number" value={item.requestedQty} onChange={e => updateCartQty(item.id, e.target.value)} className="w-20 p-1 border rounded-md" /></td>
                                                <td className="p-2"><button onClick={() => removeFromCart(item.id)} className="text-red-500 hover:text-red-700 font-bold">X</button></td>
                                            </tr>
                                        )) : <tr><td colSpan="3" className="text-center p-8 text-gray-500">Cart is empty.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                            <input type="text" placeholder="Remarks (Optional)" value={remarks} onChange={handleUppercaseChange(setRemarks)} className="w-full px-3 py-2 border rounded-lg uppercase" />
                             <div className="flex justify-end gap-4 pt-4 border-t">
                                 <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-200 rounded-full">Cancel</button>
                                 <button onClick={handleSave} disabled={isSaving || orderCart.length === 0} className="px-6 py-2 text-white bg-blue-600 rounded-full disabled:bg-blue-300">
                                     {isSaving ? 'Submitting...' : `Submit Order (${orderCart.filter(i => i.requestedQty > 0).length})`}
                                 </button>
                             </div>
                        </div>
                    </div>
                </Modal>
            );
        };
        
        // Modal for editing the printable document template
        const TemplateEditorModal = ({ template, onSave, onClose, setNotification }) => {
            const [localTemplate, setLocalTemplate] = useState(template);
            const [isSaving, setIsSaving] = useState(false);
            
            const handleChange = (e) => {
                const { name, value } = e.target;
                // Only uppercase text fields, not color pickers etc.
                const isTextField = e.target.type === 'text' || e.target.type === 'email';
                setLocalTemplate(prev => ({...prev, [name]: isTextField ? value.toUpperCase() : value }));
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2000000) { // Limit file size to 2MB
                        setNotification({ type: 'error', message: 'Image is too large. Please select an image under 2MB.' });
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setLocalTemplate(prev => ({ ...prev, logoUrl: reader.result }));
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleSave = async () => {
                setIsSaving(true);
                await onSave(localTemplate);
                setIsSaving(false);
            }
            
            return (
                <Modal onClose={onClose} size="xl">
                    <div className="space-y-6">
                        <h2 className="text-2xl font-bold text-gray-800">Edit Document Template</h2>
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium">Company Name</label>
                                <input type="text" name="companyName" value={localTemplate.companyName} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Header Title</label>
                                <input type="text" name="title" value={localTemplate.title} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium">Company Address</label>
                            <input type="text" name="companyAddress" value={localTemplate.companyAddress} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" />
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium">Company Contact #</label>
                                <input type="text" name="companyContact" value={localTemplate.companyContact} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Company Email</label>
                                <input type="email" name="companyEmail" value={localTemplate.companyEmail} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 items-center">
                            <div>
                                <label className="block text-sm font-medium">Upload Logo</label>
                                <input type="file" accept="image/*" onChange={handleFileChange} className="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                            </div>
                            <div>
                                <label className="block text-sm font-medium">Document Number Color</label>
                                <input type="color" name="color" value={localTemplate.color} onChange={handleChange} className="w-full h-10 px-1 py-1 border rounded-lg" />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4">
                             <div><label className="block text-sm font-medium">Signatory 1</label><input type="text" name="signatory1" value={localTemplate.signatory1} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" /></div>
                             <div><label className="block text-sm font-medium">Signatory 2</label><input type="text" name="signatory2" value={localTemplate.signatory2} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" /></div>
                             <div><label className="block text-sm font-medium">Signatory 3</label><input type="text" name="signatory3" value={localTemplate.signatory3} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" placeholder="Optional" /></div>
                             <div><label className="block text-sm font-medium">Signatory 4</label><input type="text" name="signatory4" value={localTemplate.signatory4} onChange={handleChange} className="w-full px-3 py-2 border rounded-lg uppercase" placeholder="Optional" /></div>
                        </div>
                        
                        <div className="flex justify-end gap-4 pt-4 border-t">
                            <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-100 rounded-full">Cancel</button>
                            <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 text-white bg-indigo-600 rounded-full disabled:bg-indigo-300">
                                {isSaving ? 'Saving...' : 'Save Template'}
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        }

        // Form for restocking inventory
        const RestockForm = ({ inventory, initialCart, onSave, onClose, setNotification }) => {
            const [cart, setCart] = useState(initialCart || []);
            const [remarks, setRemarks] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            const filteredInventory = useMemo(() => inventory.filter(i =>
                (i.name.toLowerCase().includes(searchTerm.toLowerCase()) || i.sku.toLowerCase().includes(searchTerm.toLowerCase()))
            ), [inventory, searchTerm]);
            
            const addToCart = (item) => {
                setCart(prev => {
                    if (prev.find(i => i.id === item.id)) {
                        setNotification({ type: 'info', message: `${item.name} is already in the list.` });
                        return prev;
                    }
                    return [...prev, { ...item, restockQty: 10 }];
                });
            };

            const updateCartQty = (id, qty) => setCart(prev => prev.map(i => i.id === id ? { ...i, restockQty: Math.max(0, Number(qty)) } : i));
            const removeFromCart = (id) => setCart(prev => prev.filter(i => i.id !== id));

            const handleSave = async () => {
                const finalCart = cart.filter(i => i.restockQty > 0);
                if (finalCart.length === 0) { setNotification({type: 'error', message: 'Please add at least one item with a quantity greater than zero.'}); return; }
                setIsSaving(true);
                await onSave(finalCart, remarks);
                setIsSaving(false);
            };

            return (
                <Modal onClose={onClose} size="7xl">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                         {/* Item List & Header */}
                        <div className="lg:col-span-2 space-y-4">
                            <h2 className="text-2xl font-bold text-gray-800">Restock Inventory</h2>
                           <input type="text" placeholder="Search for items to add to restock list..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                            <div className="h-[50vh] overflow-y-auto border rounded-lg">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 bg-gray-50 z-10">
                                        <tr>
                                            <th className="p-2">Name</th>
                                            <th className="p-2">Current Stock</th>
                                            <th className="p-2"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredInventory.map(item => (
                                            <tr key={item.id} className="border-b">
                                                <td className="p-2">{item.name} <span className="text-xs text-gray-400">({item.sku})</span></td>
                                                <td className="p-2">{item.qty}</td>
                                                <td className="p-2 text-right">
                                                    <button onClick={() => addToCart(item)} className="bg-blue-500 text-white px-3 py-1 text-xs rounded-full hover:bg-blue-600 disabled:bg-gray-300" disabled={cart.some(c => c.id === item.id)}>
                                                        {cart.some(c => c.id === item.id) ? 'Added' : 'Add'}
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                         {/* Restock Cart Column */}
                        <div className="space-y-4 bg-gray-50 p-4 rounded-lg">
                           <h3 className="text-xl font-bold text-gray-800">Restock List</h3>
                            <div className="h-[45vh] overflow-y-auto border rounded-lg bg-white">
                                <table className="w-full text-left text-sm">
                                    <thead className="sticky top-0 bg-gray-100 z-10"><tr><th className="p-2">Item</th><th className="p-2 w-24">Add Qty</th><th className="p-2"></th></tr></thead>
                                    <tbody>
                                        {cart.length > 0 ? cart.map(item => (
                                            <tr key={item.id} className="border-b">
                                                <td className="p-2">{item.name}</td>
                                                <td className="p-2"><input type="number" value={item.restockQty} onChange={e => updateCartQty(item.id, e.target.value)} className="w-20 p-1 border rounded-md" /></td>
                                                <td className="p-2"><button onClick={() => removeFromCart(item.id)} className="text-red-500 hover:text-red-700 font-bold">X</button></td>
                                            </tr>
                                        )) : <tr><td colSpan="3" className="text-center p-8 text-gray-500">No items added to restock list.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                           <input type="text" placeholder="Remarks / Supplier (Optional)" value={remarks} onChange={e => setRemarks(e.target.value.toUpperCase())} className="w-full px-3 py-2 border rounded-lg uppercase" />
                            <div className="flex justify-end gap-4 pt-4 border-t">
                               <button type="button" onClick={onClose} className="px-6 py-2 bg-gray-200 rounded-full">Cancel</button>
                                <button onClick={handleSave} disabled={isSaving || cart.length === 0} className="px-6 py-2 text-white bg-green-600 rounded-full disabled:bg-green-300">
                                    {isSaving ? 'Receiving...' : `Receive Stock (${cart.filter(i => i.restockQty > 0).length})`}
                                </button>
                            </div>
                        </div>
                    </div>
                </Modal>
            )
        };

        // --- Main App Component ---
        function App() {
            // --- State Declarations ---
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [inventory, setInventory] = useState([]);
            const [sites, setSites] = useState([]);
            const [deliveryReceipts, setDeliveryReceipts] = useState([]);
            const [userOrders, setUserOrders] = useState([]);
            const [restockCart, setRestockCart] = useState([]);
            const [settings, setSettings] = useState({ adminPass: 'superadmin', reorderLevel: 10, lastOrderNumber: 0, unitOptions: [...DEFAULT_ISSUING_UNITS] });
            const [drTemplate, setDrTemplate] = useState({ 
                title: 'DELIVERY RECEIPT', 
                logoUrl: '', 
                color: '#dc2626',
                companyName: '', companyAddress: '', companyContact: '', companyEmail: '',
                signatory1: 'Received by / Date', signatory2: 'Issued by', signatory3: '', signatory4: ''
            });
            const [isLoading, setIsLoading] = useState(true);
            const [modal, setModal] = useState(null);
            const [notification, setNotification] = useState(null);
            const [currentItem, setCurrentItem] = useState(null); 
            const [pendingReceipt, setPendingReceipt] = useState(null);
            const [pendingReceiptOrigin, setPendingReceiptOrigin] = useState('inventory');
            const [receiptDraft, setReceiptDraft] = useState(() => loadStoredJSON(STORAGE_KEYS.inventoryReceiptDraft));
            const [manualReceiptDraft, setManualReceiptDraft] = useState(() => loadStoredJSON(STORAGE_KEYS.manualReceiptDraft));
            const [receiptToVoid, setReceiptToVoid] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            // --- Global App ID ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // --- Firebase Initialization and Auth Effect ---
            useEffect(() => {
                persistStoredJSON(STORAGE_KEYS.manualReceiptDraft, manualReceiptDraft);
            }, [manualReceiptDraft]);

            useEffect(() => {
                persistStoredJSON(STORAGE_KEYS.inventoryReceiptDraft, receiptDraft);
            }, [receiptDraft]);

            useEffect(() => {
                try {
                    const firebaseConfig = typeof __firebase_config !== 'undefined'
                        ? JSON.parse(__firebase_config)
                        : {
                            apiKey: "AIzaSyC9Tf7tOlZhYNe6ubDZ7JFJhsMswiimxPw",
                            authDomain: "dlv-warehouse-tracker.firebaseapp.com",
                            projectId: "dlv-warehouse-tracker",
                            storageBucket: "dlv-warehouse-tracker.appspot.com",
                            messagingSenderId: "267729758583",
                            appId: "1:267729758583:web:f5f7ca26afc99c17819972",
                            measurementId: "G-1DH9GT5RXS"
                          };

                    if (!firebaseConfig?.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                        setNotification({ type: 'error', message: 'Firebase configuration is missing or invalid. App cannot start.' });
                        setIsAuthReady(true); setIsLoading(false); return;
                    }
                    
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            setUser(user); setIsAuthReady(true);
                        } else {
                            const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            const signInPromise = authToken ? signInWithCustomToken(auth, authToken) : signInAnonymously(auth);
                            signInPromise.catch(e => {
                                console.error("Sign-in failed", e);
                                setNotification({type: 'error', message: `Authentication failed: ${e.message}`});
                                setIsAuthReady(true);
                            });
                        }
                    });
                    return () => unsubscribe();
                } catch (e) {
                    console.error("CRITICAL: Firebase initialization failed.", e);
                    setNotification({ type: 'error', message: `Failed to initialize backend. ${e.message}` });
                    setIsAuthReady(true); setIsLoading(false);
                }
            }, []);

            // --- Data Fetching Effect ---
            useEffect(() => {
                if (!isAuthReady || !user) return; 
                
                setIsLoading(true);
                const basePath = `artifacts/${appId}/public/data`;
                
                const unsubInv = onSnapshot(query(collection(db, `${basePath}/inventory`), orderBy('name')), snap => setInventory(snap.docs.map(d => ({ id: d.id, ...d.data() }))), err => console.error("Inventory snapshot error:", err));
                const unsubSites = onSnapshot(query(collection(db, `${basePath}/sites`), orderBy('name')), snap => setSites(snap.docs.map(d => ({id: d.id, ...d.data()}))), err => console.error("Sites snapshot error:", err));
                const unsubReceipts = onSnapshot(query(collection(db, `${basePath}/deliveryReceipts`), orderBy('createdAt', 'desc')), snap => setDeliveryReceipts(snap.docs.map(d => ({id: d.id, ...d.data()}))), err => console.error("Receipts snapshot error:", err));
                const unsubOrders = onSnapshot(query(collection(db, `${basePath}/userOrders`), orderBy('createdAt', 'desc')), snap => setUserOrders(snap.docs.map(d => ({id: d.id, ...d.data()}))), err => console.error("User Orders snapshot error:", err));
                const unsubSettings = onSnapshot(
                    doc(db, `${basePath}/settings/general`),
                    (d) => {
                        if (d.exists()) {
                            const data = d.data();
                            const normalizedUnits = ensurePreferredUnitList(data.unitOptions);
                            setSettings(prev => ({
                                ...prev,
                                ...data,
                                unitOptions: normalizedUnits
                            }));
                            setGlobalUnitOptions(normalizedUnits);
                        }
                    },
                    err => console.error("Settings snapshot error:", err)
                );
                const unsubTemplate = onSnapshot(doc(db, `${basePath}/settings/dr_template`), (d) => { if (d.exists()) { setDrTemplate(t => ({...t, ...d.data()})); } }, err => console.error("DR Template snapshot error:", err));

                setIsLoading(false);

                return () => { unsubInv(); unsubSites(); unsubReceipts(); unsubOrders(); unsubSettings(); unsubTemplate(); };
            }, [isAuthReady, user, appId]);
            
            // --- Helper to log actions ---
             const logAction = async (action, details) => {
                 if(!db) return;
                 try {
                     await addDoc(collection(db, `artifacts/${appId}/public/data/logs`), { 
                         timestamp: serverTimestamp(), action, details, user: isAdminMode ? 'Admin' : 'User' 
                     });
                 } catch (error) { console.error("Failed to log action:", error); }
             };

            // --- Business Logic Handlers ---
            const handleSaveSite = async (siteData) => {
                const path = `artifacts/${appId}/public/data/sites`;
                try {
                    if (siteData.id) { // Editing
                        const { id, ...dataToSave } = siteData;
                        await updateDoc(doc(db, path, id), dataToSave);
                        setNotification({type: 'success', message: `Site "${siteData.name}" updated.`});
                        await logAction('Site Updated', `Updated site: ${siteData.name}`);
                    } else { // Adding
                        await addDoc(collection(db, path), { ...siteData, lastDrNumber: 0, status: 'Active' });
                        setNotification({type: 'success', message: `Site "${siteData.name}" added.`});
                        await logAction('Site Added', `New site created: ${siteData.name}`);
                    }
                } catch(e) {
                    setNotification({type: 'error', message: `Failed to save site: ${e.message}`});
                }
            };

            const handleFinishSite = async (site) => {
                if (!site || site.status === 'Finished') return;
                const siteRef = doc(db, `artifacts/${appId}/public/data/sites`, site.id);
                try {
                    await updateDoc(siteRef, { status: 'Finished' });
                    setNotification({type: 'success', message: `Site "${site.name}" marked as finished.`});
                    await logAction('Site Finished', `Site ${site.name} was marked as finished.`);
                } catch(e) {
                    setNotification({type: 'error', message: `Failed to update site status: ${e.message}`});
                }
            };

            const handleReactivateSite = async (site) => {
                if (!site || site.status !== 'Finished') return;
                const siteRef = doc(db, `artifacts/${appId}/public/data/sites`, site.id);
                try {
                    await updateDoc(siteRef, { status: 'Active' });
                    setNotification({type: 'success', message: `Site "${site.name}" has been re-activated.`});
                    await logAction('Site Re-activated', `Site ${site.name} was marked as active.`);
                } catch(e) {
                    setNotification({type: 'error', message: `Failed to update site status: ${e.message}`});
                }
            };
            
            const handleRestockItems = async (itemsToRestock, remarks) => {
                 try {
                     await runTransaction(db, async (transaction) => {
                         for (const item of itemsToRestock) {
                             const itemRef = doc(db, `artifacts/${appId}/public/data/inventory`, item.id);
                             transaction.update(itemRef, { qty: increment(item.restockQty) });
                         }
                     });
                     
                     const itemNames = itemsToRestock.map(i => `${i.name} (x${i.restockQty})`).join(', ');
                     await logAction('Inventory Restocked', `Items: ${itemNames}. Remarks: ${remarks}`);
                     setNotification({type: 'success', message: 'Inventory has been restocked.'});
                     setRestockCart([]);
                     closeModal();
                 } catch(e) { console.error("Restock transaction failed:", e); setNotification({type: 'error', message: `Failed to restock items: ${e.message}`}); }
            }

            const handleSaveUserOrder = async (orderData) => {
                const orderCollectionRef = collection(db, `artifacts/${appId}/public/data/userOrders`);
                const settingsRef = doc(db, `artifacts/${appId}/public/data/settings/general`);
                try {
                    await runTransaction(db, async (transaction) => {
                        const settingsDoc = await transaction.get(settingsRef);
                        const lastOrderNumber = settingsDoc.exists() ? settingsDoc.data().lastOrderNumber || 0 : 0;
                        const newOrderNumber = lastOrderNumber + 1;
                        const orderNumberString = `REQ-${String(newOrderNumber).padStart(5, '0')}`;
                        transaction.set(doc(orderCollectionRef), { ...orderData, orderNumber: orderNumberString, status: 'Pending', createdAt: serverTimestamp() });
                        transaction.set(settingsRef, { lastOrderNumber: newOrderNumber }, { merge: true });
                    });
                    
                    setNotification({type: 'success', message: 'Your order has been submitted!'});
                    await logAction('Order Submitted', `By user ${orderData.requestedBy}`);
                    closeModal();
                } catch (e) { console.error("User order save failed:", e); setNotification({type: 'error', message: `Failed to submit order: ${e.message}`}); }
            };
            
            const handleUpdateOrderStatus = async (order) => {
                if(!order) return;
                const orderRef = doc(db, `artifacts/${appId}/public/data/userOrders`, order.id);
                try {
                    await updateDoc(orderRef, { status: 'Completed' });
                    setNotification({type: 'success', message: `Order ${order.orderNumber} marked as completed.`});
                    await logAction('Order Completed', `Order ${order.orderNumber}`);
                } catch(e) { setNotification({type: 'error', message: `Failed to update order: ${e.message}`}); }
            };
            
            const handleSaveReceipt = async (receiptData) => {
                const receiptsCollectionRef = collection(db, `artifacts/${appId}/public/data/deliveryReceipts`);
                try {
                    let finalDrNumber;
                    await runTransaction(db, async (transaction) => {
                        const siteRef = doc(db, `artifacts/${appId}/public/data/sites`, receiptData.siteId);
                        const siteDoc = await transaction.get(siteRef);
                        if (!siteDoc.exists()) throw new Error("Selected site does not exist.");

                        const inventoryItems = (receiptData.items || []).filter(item => !item.isManual);
                        const itemRefs = inventoryItems.map(item => doc(db, `artifacts/${appId}/public/data/inventory`, item.id));
                        const itemDocs = await Promise.all(itemRefs.map(ref => transaction.get(ref)));

                        for(let i = 0; i < itemDocs.length; i++) {
                            const invItemDoc = itemDocs[i];
                            const requestedItem = inventoryItems[i];
                            if (!invItemDoc.exists()) {
                                throw new Error(`Inventory item "${requestedItem?.name || requestedItem?.id}" no longer exists.`);
                            }
                            if (invItemDoc.data().qty < requestedItem.dispatchQty) {
                                throw new Error(`Insufficient stock for ${requestedItem.name}. Available: ${invItemDoc.data().qty}, Required: ${requestedItem.dispatchQty}.`);
                            }
                        }

                        const newDrNumber = siteDoc.data().lastDrNumber + 1;
                        const drNumberString = `${siteDoc.data().drPrefix}-${String(newDrNumber).padStart(5, '0')}`;
                        finalDrNumber = drNumberString;

                        for (let i = 0; i < inventoryItems.length; i++) {
                            transaction.update(itemRefs[i], { qty: increment(-inventoryItems[i].dispatchQty) });
                        }

                        transaction.set(doc(receiptsCollectionRef), { ...receiptData, drNumber: drNumberString, siteName: siteDoc.data().name, createdAt: serverTimestamp(), status: 'Active' });
                        transaction.update(siteRef, { lastDrNumber: increment(1) });
                    });

                    setNotification({ type: 'success', message: `Receipt ${finalDrNumber} saved successfully!`});
                    await logAction('Receipt Created', `DR ${finalDrNumber} for site ${receiptData.siteId} saved.`);
                    if (pendingReceiptOrigin === 'manual') {
                        setManualReceiptDraft(null);
                    } else {
                        setReceiptDraft(null);
                    }
                    return true;
                } catch (error) {
                    console.error("Receipt save transaction failed: ", error);
                    setNotification({ type: 'error', message: `Failed to save receipt: ${error.message}` });
                    return false;
                }
            };
            
            const handlePreviewAndFinalize = (receiptData) => {
                const { origin, ...payload } = receiptData || {};
                const selectedSite = sites.find(s => s.id === payload.siteId);
                const nextDrNumber = (selectedSite?.lastDrNumber || 0) + 1;
                const drNumberString = `${selectedSite?.drPrefix || 'DR'}-${String(nextDrNumber).padStart(5, '0')}`;

                const dataForPreview = {
                    ...payload,
                    drNumber: drNumberString,
                    siteName: selectedSite?.name || 'N/A',
                    createdAt: { toDate: () => new Date() } // Mock server timestamp
                };
                setPendingReceiptOrigin(origin === 'manual' ? 'manual' : 'inventory');
                setPendingReceipt(dataForPreview);
                setModal('receipt_confirm_and_preview');
            };

            const handleVoidReceipt = async (receipt) => {
                if (!receipt || receipt.status !== 'Active') {
                    setReceiptToVoid(null); return;
                }
                try {
                    await runTransaction(db, async (transaction) => {
                        const receiptRef = doc(db, `artifacts/${appId}/public/data/deliveryReceipts`, receipt.id);
                        const itemRefs = receipt.items.map(item => doc(db, `artifacts/${appId}/public/data/inventory`, item.id));
                        const itemDocs = await Promise.all(itemRefs.map(ref => transaction.get(ref)));

                        for (let i = 0; i < receipt.items.length; i++) {
                            if (itemDocs[i].exists()) {
                                transaction.update(itemRefs[i], { qty: increment(receipt.items[i].dispatchQty) });
                            }
                        }
                        transaction.update(receiptRef, { status: 'Voided' });
                    });
                    
                    await logAction('Receipt Voided', `DR ${receipt.drNumber} was voided.`);
                    setNotification({type: 'success', message: `Receipt ${receipt.drNumber} has been voided.`});
                    setReceiptToVoid(null);
                    closeModal(); 
                } catch(e) { console.error("Void receipt transaction failed:", e); setNotification({type: 'error', message: `Failed to void receipt: ${e.message}`}); setReceiptToVoid(null); }
            };

            const handleFinishReceipt = async (receipt) => {
                if (!receipt || receipt.status !== 'Active') return;
                const receiptRef = doc(db, `artifacts/${appId}/public/data/deliveryReceipts`, receipt.id);
                try {
                    await updateDoc(receiptRef, { status: 'Finished' });
                    setNotification({type: 'success', message: `Receipt ${receipt.drNumber} marked as finished.`});
                    await logAction('Receipt Finished', `DR ${receipt.drNumber} was marked as finished.`);
                } catch(e) {
                    setNotification({type: 'error', message: `Failed to update receipt status: ${e.message}`});
                }
            };
            
            // --- CRUD Handlers ---
            const handleSaveItem = async (item) => {
                const path = `artifacts/${appId}/public/data/inventory`;
                try {
                    // Normalize inputs for comparison
                    const itemNameLower = item.name.trim().toLowerCase();
                    const itemBrandLower = (item.brand || '').trim().toLowerCase();
                    const itemSkuLower = item.sku.trim().toLowerCase();

                    if (item.id) { // Editing existing item
                        const conflictingSku = inventory.find(invItem =>
                            invItem.id !== item.id && invItem.sku.trim().toLowerCase() === itemSkuLower
                        );
                        if (conflictingSku) {
                            setNotification({ type: 'error', message: `SKU "${item.sku}" is already used by another item.` });
                            return;
                        }

                        const conflictingNameAndBrand = inventory.find(invItem =>
                            invItem.id !== item.id &&
                            invItem.name.trim().toLowerCase() === itemNameLower &&
                            (invItem.brand || '').trim().toLowerCase() === itemBrandLower
                        );
                        if (conflictingNameAndBrand) {
                            setNotification({ type: 'error', message: `An item with name "${item.name}" and brand "${item.brand}" already exists.` });
                            return;
                        }

                        const { id, qty, ...itemData } = item;
                        await updateDoc(doc(db, path, id), itemData);
                        await logAction('Item Updated', `Updated details for "${item.name}" (SKU: ${item.sku})`);
                        setNotification({ type: 'success', message: 'Item details successfully updated.' });
                    } else { // Adding new item
                        const conflictingSku = inventory.find(invItem => invItem.sku.trim().toLowerCase() === itemSkuLower);
                        if (conflictingSku) {
                            setNotification({ type: 'error', message: `SKU "${item.sku}" already exists. Please use a unique SKU.` });
                            return;
                        }

                        const conflictingNameAndBrand = inventory.find(invItem =>
                            invItem.name.trim().toLowerCase() === itemNameLower &&
                            (invItem.brand || '').trim().toLowerCase() === itemBrandLower
                        );
                        if (conflictingNameAndBrand) {
                            setNotification({ type: 'error', message: `An item with name "${item.name}" and brand "${item.brand}" already exists.` });
                            return;
                        }
                        
                        await addDoc(collection(db, path), item);
                        await logAction('Item Added', `Added new item "${item.name}" (SKU: ${item.sku}) with initial quantity ${item.qty}`);
                        setNotification({ type: 'success', message: 'Item successfully added.' });
                    }
                    closeModal();
                } catch (e) { console.error("Save item error:", e); setNotification({ type: 'error', message: `Failed to save item: ${e.message}` }); }
            };

            const handleDeleteItem = async (id, name) => {
                const path = `artifacts/${appId}/public/data/inventory`;
                try {
                    await deleteDoc(doc(db, path, id));
                    await logAction('Item Deleted', `Deleted item "${name}"`);
                    setNotification({type: 'success', message: 'Item successfully deleted.'});
                } catch (e) { console.error("Delete error:", e); setNotification({type: 'error', message: `Failed to delete item: ${e.message}`}); }
            };

            const handleAdjustStock = async (item, adjustment) => {
                const path = `artifacts/${appId}/public/data/inventory`;
                const newQty = item.qty + adjustment;
                if (newQty < 0) {
                     setNotification({type: 'error', message: "Stock quantity cannot go below zero."}); return;
                }
                try {
                    const itemRef = doc(db, path, item.id);
                    await updateDoc(itemRef, { qty: increment(adjustment) });
                    await logAction('Stock Adjusted', `${item.name} quantity changed by ${adjustment}. New Qty: ${newQty}`);
                    setNotification({type: 'success', message: 'Stock adjusted successfully!'});
                    closeModal();
                } catch (e) { console.error("Stock adjustment error:", e); setNotification({type: 'error', message: `Failed to adjust stock: ${e.message}`}); }
            };
            
            const handleSaveSettings = async (newSettings) => {
                try {
                    const sanitizedUnits = ensurePreferredUnitList(newSettings.unitOptions);
                    const payload = { ...newSettings, unitOptions: sanitizedUnits };
                    await setDoc(doc(db, `artifacts/${appId}/public/data/settings`, 'general'), payload, { merge: true });
                    setSettings(prev => ({ ...prev, ...payload }));
                    setGlobalUnitOptions(sanitizedUnits);
                    await logAction('Settings Updated', 'Admin preferences were updated.');
                    setNotification({type: 'success', message: 'Settings saved successfully!'});
                    closeModal();
                } catch (e) {
                    console.error("Settings save error:", e);
                    setNotification({type: 'error', message: `Failed to save settings: ${e.message}`});
                }
            };
            
            const handleSaveDrTemplate = async (newTemplate) => {
                try {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/settings`, 'dr_template'), newTemplate);
                    await logAction('DR Template Updated', 'Delivery receipt template was modified.');
                    setNotification({type: 'success', message: 'DR Template saved!'});
                    closeModal();
                } catch (e) { console.error("DR Template save error:", e); setNotification({type: 'error', message: `Failed to save template: ${e.message}`}); }
            };
            
            // --- Restock Cart ---
            const handleAddToRestockCart = (item) => {
                setRestockCart(prev => {
                     if (prev.find(i => i.id === item.id)) {
                         setNotification({ type: 'info', message: `${item.name} is already in the restock list.` });
                         return prev;
                     }
                    return [...prev, { ...item, restockQty: 10 }];
                });
            }

            // --- Auth & Modal Handlers ---
            const handleAdminLogin = (password) => {
                if (password === settings.adminPass) {
                    setIsAdminMode(true);
                    closeModal();
                    setNotification({type: 'success', message: 'Admin mode unlocked!'});
                } else {
                    setNotification({type: 'error', message: 'Incorrect admin password.'});
                }
            };
            
            const openModal = (type, item = null) => {
                setCurrentItem(item);
                setModal(type);
            };

            const closeModal = ({ preserveReceiptDraft = false, preserveManualDraft = false } = {}) => {
                setModal(null);
                setCurrentItem(null);
                setPendingReceipt(null);
                setPendingReceiptOrigin('inventory');
                if (!preserveReceiptDraft) {
                    setReceiptDraft(null);
                }
                if (!preserveManualDraft) {
                    setManualReceiptDraft(null);
                }
            };

            const closeReceiptComposer = () => closeModal({ preserveReceiptDraft: true });
            const returnToReceiptComposer = () => {
                setPendingReceipt(null);
                setModal(pendingReceiptOrigin === 'manual' ? 'manual_receipt' : 'receipt');
            };

            // --- Render Logic ---
            if (!isAuthReady || isLoading) return <Spinner text={!isAuthReady ? "Initializing..." : "Loading data..."} />;
            
            const drManagerActions = isAdminMode ? [
                {
                    label: "Mark as Finished",
                    handler: handleFinishReceipt,
                    disabled: (r) => r.status !== 'Active',
                    className: "text-blue-600 hover:underline text-sm disabled:text-gray-400 disabled:no-underline"
                },
                {
                    label: "Void",
                    handler: (r) => setReceiptToVoid(r),
                    disabled: (r) => r.status !== 'Active',
                    className: "text-red-600 hover:underline text-sm disabled:text-gray-400 disabled:no-underline"
                }
            ] : [];

            return (
                <>
                    <div className="min-h-screen font-sans text-gray-800">
                        <style>{`
                            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap'); 
                            body { font-family: 'Poppins', sans-serif; } 
                            @keyframes scale-in{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
                            .animate-scale-in{animation:scale-in .2s ease-out forwards} 
                            
                            @media print {
                                body > :not(#print-area) { display: none !important; }
                                #print-area { display: block !important; }
                            }
                        `}</style>
                        
                        <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                            <header className="flex flex-wrap justify-between items-center gap-4 mb-8">
                                <div>
                                    <h1 className="text-4xl font-bold text-gray-900">Warehouse Management</h1>
                                    <p className="text-gray-500 mt-1">
                                        Status: <span className={isAdminMode ? "font-bold text-indigo-600" : ""}>{isAdminMode ? "Administrator Mode" : "User Mode"}</span>
                                    </p>
                                </div>
                                <div className="flex items-center gap-2 flex-wrap">
                                     <button onClick={() => isAdminMode ? setIsAdminMode(false) : openModal('admin_login')} className="bg-white text-gray-700 font-semibold p-2 rounded-full hover:bg-gray-100 shadow-sm border" title={isAdminMode ? "Lock Admin Mode" : "Admin Access"}>
                                         {isAdminMode ? 'üîì' : 'üõ°Ô∏è'}
                                     </button>
                                     
                                     {isAdminMode ? (
                                         <>
                                             <button onClick={() => openModal('sites')} className="bg-white text-sm text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">Sites</button>
                                             <button onClick={() => openModal('order_list')} className="bg-white text-sm text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">Order List</button>
                                             <button onClick={() => openModal('dr_template_editor')} className="bg-white text-sm text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">Edit Template</button>
                                             <button onClick={() => openModal('settings')} className="bg-white text-gray-700 font-semibold p-2 rounded-full hover:bg-gray-100 shadow-sm border" title="Settings">‚öôÔ∏è</button>
                                             <button onClick={() => openModal('reports')} className="bg-purple-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-purple-700 shadow-md text-sm">üìä Reports</button>
                                             <button onClick={() => openModal('item')} className="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-indigo-700 shadow-md text-sm">‚ûï Add Item</button>
                                             <button onClick={() => openModal('restock')} className="bg-green-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-green-700 shadow-md text-sm relative">
                                                 Restock Items
                                                 {restockCart.length > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">{restockCart.length}</span>}
                                             </button>
                                         </>
                                     ) : (
                                         <button onClick={() => openModal('user_order')} className="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 shadow-md text-sm">üìù Order</button>
                                     )}
                                     
                                    <button onClick={() => openModal('dr_manager')} className="bg-white text-sm text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-100 shadow-sm border">Manage Receipts</button>
                                    <button onClick={() => openModal('manual_receipt')} className="bg-amber-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-amber-600 shadow-md text-sm">‚úçÔ∏è Manual Receipt</button>
                                    <button onClick={() => openModal('receipt')} className="bg-teal-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-teal-600 shadow-md text-sm">üßæ Create Receipt</button>
                                </div>
                            </header>
                            
                            <main className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-3"><StatsWidget inventory={inventory} /></div>
                                <LowStockWidget inventory={inventory} settings={settings} onRestock={handleAddToRestockCart} setNotification={setNotification} />
                                <AllInventoryWidget 
                                    inventory={inventory}
                                    onEdit={(item) => openModal('item', item)} 
                                    onDelete={handleDeleteItem} 
                                    onAdjustStock={(item) => openModal('stock', item)}
                                    isLoading={isLoading} 
                                    searchTerm={searchTerm} 
                                    setSearchTerm={setSearchTerm} 
                                    isAdminMode={isAdminMode}
                                    settings={settings} 
                                />
                                 <LogsWidget isLoading={isLoading} appId={appId} />
                            </main>
                        </div>
                    </div>

                    {/* --- Modals Layer --- */}
                    {notification && <NotificationModal message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                    
                    <ConfirmationModal isOpen={!!receiptToVoid} onClose={() => setReceiptToVoid(null)} onConfirm={() => handleVoidReceipt(receiptToVoid)} message={`Void DR "${receiptToVoid?.drNumber}"? This will return all items to stock. This cannot be undone.`} confirmText="Void Receipt"/>

                    {modal === 'item' && <Modal onClose={closeModal} size="lg"><ItemForm currentItem={currentItem} onSave={handleSaveItem} onClose={closeModal} setNotification={setNotification} unitOptions={settings.unitOptions} /></Modal>}
                    {modal === 'stock' && <StockAdjustmentForm item={currentItem} onAdjust={handleAdjustStock} onClose={closeModal} setNotification={setNotification} />}
                    {modal === 'admin_login' && <AdminLoginModal onLogin={handleAdminLogin} onClose={closeModal} />}
                    {modal === 'settings' && <SettingsForm settings={settings} onSave={handleSaveSettings} onClose={closeModal} />}
                    {modal === 'sites' && <SiteManagementForm sites={sites} onSave={handleSaveSite} onFinishSite={handleFinishSite} onReactivateSite={handleReactivateSite} onClose={closeModal} setNotification={setNotification} />}
                    {modal === 'manual_receipt' && (
                        <ManualReceiptModal
                            sites={sites}
                            unitOptions={settings.unitOptions}
                            onFinalize={handlePreviewAndFinalize}
                            onClose={() => closeModal({ preserveManualDraft: true })}
                            setNotification={setNotification}
                            initialData={manualReceiptDraft}
                            onDraftChange={setManualReceiptDraft}
                        />
                    )}
                    {modal === 'receipt' && (
                        <DeliveryReceiptForm
                            inventory={inventory}
                            sites={sites}
                            onFinalize={handlePreviewAndFinalize}
                            onClose={closeReceiptComposer}
                            setNotification={setNotification}
                            initialData={receiptDraft}
                            onDraftChange={setReceiptDraft}
                        />
                    )}
                    {modal === 'user_order' && <UserOrderForm inventory={inventory} onSave={handleSaveUserOrder} onClose={closeModal} setNotification={setNotification} user={user} />}
                    {modal === 'dr_template_editor' && <TemplateEditorModal template={drTemplate} onSave={handleSaveDrTemplate} onClose={closeModal} setNotification={setNotification} />}
                    {modal === 'restock' && <RestockForm inventory={inventory} initialCart={restockCart} onSave={handleRestockItems} onClose={closeModal} setNotification={setNotification}/>}

                    {modal === 'reports' && (
                        <ReportsModal
                            receipts={deliveryReceipts}
                            inventory={inventory}
                            sites={sites}
                            onClose={closeModal}
                        />
                    )}

                    {modal === 'dr_manager' && (
                        <DocumentHistoryModal
                            documents={deliveryReceipts}
                            onClose={closeModal}
                            openDetailView={(r) => openModal('dr_detail', r)}
                            title="Delivery Receipt Manager"
                            actions={drManagerActions}
                            type="dr_manager"
                            template={drTemplate}
                        />
                    )}
                    {modal === 'dr_detail' && <ReceiptDetailView receipt={currentItem} onClose={closeModal} template={drTemplate} />}

                    {modal === 'order_list' && <DocumentHistoryModal documents={userOrders} onClose={closeModal} openDetailView={(r) => openModal('order_detail', r)} title="User Order List" actions={[{label: "Mark Completed", handler: handleUpdateOrderStatus, disabled: (r) => r.status === 'Completed', className: "text-green-600 hover:underline text-sm disabled:text-gray-400 disabled:no-underline"}]} />}
                    {modal === 'order_detail' && <ReceiptDetailView receipt={currentItem} onClose={closeModal} template={drTemplate} />}
                    
                    {modal === 'receipt_confirm_and_preview' && pendingReceipt && (
                        <ReceiptDetailView
                            receipt={pendingReceipt}
                            template={drTemplate}
                            isPreview={true}
                            onConfirm={() => handleSaveReceipt(pendingReceipt)}
                            onCancel={returnToReceiptComposer}
                            onDone={() => { setPendingReceipt(null); closeModal(); }}
                            confirmText="Save & Prepare for Printing"
                        />
                    )}

                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
